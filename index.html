<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Diárias</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Variáveis de Design Global */
        :root {
            --color-primary: #3f6ad8; /* Azul principal mais moderno */
            --color-secondary: #6c757d; /* Cinza secundário */
            --color-success: #28a745; /* Verde padrão */
            --color-danger: #dc3545; /* Vermelho padrão */
            
            --color-background-light: #f8f9fa; /* Fundo suave, quase branco */
            --color-background-medium: #e9ecef; /* Para cabeçalhos de tabela */
            --color-surface: #ffffff; /* Fundo de cards e elementos */
            
            --color-text-dark: #343a40; /* Texto principal escuro */
            --color-text-muted: #6c757d; /* Texto secundário */
            --color-text-on-primary: #ffffff; /* Texto sobre o azul principal */
            
            --border-radius-soft: 0.5rem; /* Bordas arredondadas */
            --shadow-subtle: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.08); /* Sombra mais discreta */
            --shadow-medium: 0 0.3rem 0.8rem rgba(0, 0, 0, 0.12); /* Sombra ao hover */
            
            --spacing-unit: 1rem; /* Unidade base de espaçamento */
        }

        /* Base do Corpo */
        body {
            font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; /* Fonte mais moderna e limpa */
            margin: 0;
            padding: var(--spacing-unit);
            background-color: var(--color-background-light);
            color: var(--color-text-dark);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            line-height: 1.6;
            font-size: 16px; /* Tamanho base da fonte */
        }

        /* Contêiner Principal */
        .container {
            width: 100%;
            max-width: 1024px; /* Um pouco más compacto para foco */
            margin-top: calc(var(--spacing-unit) * 2);
        }

        /* Gerenciamento de Telas */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeInView 0.5s ease-out; }
        @keyframes fadeInView { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Estilo dos Cards */
        .card {
            background-color: var(--color-surface);
            padding: calc(var(--spacing-unit) * 1.5);
            border-radius: var(--border-radius-soft);
            box-shadow: var(--shadow-subtle);
            border: 1px solid var(--color-background-medium); /* Borda sutil */
            margin-bottom: var(--spacing-unit);
        }

        /* Títulos */
        h1, h2, h3 { 
            text-align: center; 
            margin-top: 0; 
            color: var(--color-primary); /* Títulos em cor primária */
            line-height: 1.2; 
            font-weight: 600; /* Más peso */
        }
        h1 { font-size: 2.2rem; margin-bottom: var(--spacing-unit); }
        h2 { font-size: 1.8rem; text-align: left; margin-bottom: calc(var(--spacing-unit) * 1.2); }
        h3 { 
            text-align: left; /* Default para h3 internos */
            border-bottom: 1px solid var(--color-background-medium); 
            padding-bottom: calc(var(--spacing-unit) * 0.5); 
            margin-bottom: calc(var(--spacing-unit) * 1.25); 
            font-size: 1.3rem;
            color: var(--color-text-dark); /* Sub-títulos em texto escuro */
        }

        /* Botões Base */
        button {
            border: none;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius-soft);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-subtle);
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            opacity: 0.95;
        }
        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }

        .btn-primary { background-color: var(--color-primary); color: var(--color-text-on-primary); }
        .btn-secondary { background-color: var(--color-secondary); color: var(--color-text-on-primary); }
        .btn-success { background-color: var(--color-success); color: var(--color-text-on-primary); }
        
        /* Inputs e Selects */
        input, select {
            width: 100%;
            padding: calc(var(--spacing-unit) * 0.75);
            margin-bottom: var(--spacing-unit);
            border: 1px solid var(--input-border-color);
            border-radius: var(--border-radius-soft);
            box-sizing: border-box;
            font-size: 1rem;
            background-color: var(--color-surface);
            color: var(--color-text-dark);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input:focus, select:focus {
            border-color: var(--color-primary);
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(63, 106, 216, 0.25); /* Sombra de foco com a cor primária */
        }
        input[type="checkbox"] { 
            width: auto; height: auto; transform: scale(1.1); margin-left: 5px; 
            vertical-align: middle; 
            margin-bottom: 0; 
        }
        input[readonly] { 
            background-color: var(--color-background-light); 
            cursor: not-allowed; 
            opacity: 0.8; 
        }
        
        label { 
            display: block; margin-bottom: calc(var(--spacing-unit) * 0.5); 
            font-weight: 500; 
            color: var(--color-text-dark); 
        }
        .form-group { margin-bottom: var(--spacing-unit); }
        
        /* Mensagens de Erro */
        #loginErrorMessage, #createUserErrorMessage, #changePasswordErrorMessage, #listarLoginsMessage { 
            color: var(--color-danger); 
            margin-top: var(--spacing-unit); 
            text-align: center; 
            display: none; 
            font-weight: 600; 
            background-color: rgba(220, 53, 69, 0.1); 
            padding: calc(var(--spacing-unit) * 0.5);
            border-radius: var(--border-radius-soft);
            border: 1px solid var(--color-danger);
        }

        /* Cabeçalho do Dashboard */
        .dashboard-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: calc(var(--spacing-unit) * 1.5); 
            flex-wrap: wrap; 
        }
        .dashboard-header div { margin-bottom: var(--spacing-unit); }
        .dashboard-header button { width: 100%; } 

        /* Wrapper de Login */
        .login-wrapper { max-width: 400px; margin: calc(var(--spacing-unit) * 3) auto; }
        .login-wrapper .app-title { font-size: 2rem; margin-bottom: calc(var(--spacing-unit) * 1.5); color: var(--color-primary); }

        /* Estilo das Tabelas de Dados */
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9rem; 
            background-color: var(--color-surface);
        }
        .data-table th, .data-table td { 
            border: 1px solid var(--color-background-medium); 
            padding: calc(var(--spacing-unit) * 0.6); 
            text-align: left; 
        }
        .data-table thead th { 
            background-color: var(--color-background-medium); 
            font-weight: 600; 
            color: var(--color-text-dark);
            text-transform: uppercase; 
        }
        .data-table tbody tr:nth-child(even) { 
            background-color: var(--color-background-light);
        }
        .data-table tbody tr:hover { 
            background-color: #e2e6ea; 
            cursor: default;
        }
        
        .card .table-responsive {
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 5px; 
            border-radius: var(--border-radius-soft); 
            border: 1px solid var(--color-background-medium);
        }

        /* Grid de Botões do Admin/Usuário */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: var(--spacing-unit); 
            margin-top: var(--spacing-unit);
        }
        .admin-button {
            height: 120px; 
            font-size: 0.9rem; 
            padding: 0.5rem;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background-color: var(--color-surface); 
            border: 1px solid var(--color-background-medium);
            border-radius: var(--border-radius-soft);
            text-decoration: none; 
            color: var(--color-text-dark); 
            box-shadow: var(--shadow-subtle);
        }
        .admin-button:hover {
            transform: translateY(-3px); 
            box-shadow: var(--shadow-medium);
            background-color: var(--color-background-light); 
        }
        .admin-button svg { 
            width: 38px; height: 38px; 
            margin-bottom: calc(var(--spacing-unit) * 0.5); 
            color: var(--color-primary); 
        }
        .admin-button span {
            font-weight: 500;
        }

        /* Linhas de Formulário */
        .form-row { 
            display: flex; 
            gap: var(--spacing-unit); 
            flex-direction: column; 
        }
        .form-row .form-group { flex: 1; }

        /* Media Queries para Telas Maiores (Desktop/Tablet) */
        @media (min-width: 768px) {
            body { padding: calc(var(--spacing-unit) * 2); }
            .container { margin-top: calc(var(--spacing-unit) * 2.5); }
            .card { padding: calc(var(--spacing-unit) * 2); }
            h1 { font-size: 2.5rem; }
            h2 { font-size: 2rem; }
            h3 { text-align: left; font-size: 1.5rem; } 
            button { padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5); }
            .dashboard-header { flex-wrap: nowrap; }
            .dashboard-header div { margin-bottom: 0; }
            .dashboard-header button { width: auto; }
            .admin-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
                gap: calc(var(--spacing-unit) * 1.5);
                margin-top: calc(var(--spacing-unit) * 1.5);
            }
            .admin-button {
                height: 140px; 
                font-size: 1rem;
                padding: var(--spacing-unit);
            }
            .admin-button svg { 
                width: 44px; height: 44px; 
                margin-bottom: var(--spacing-unit); 
            }
            .form-row { flex-direction: row; }
            .data-table { font-size: 1rem; }
            .data-table th, .data-table td { padding: calc(var(--spacing-unit) * 0.75); }
        }
        /* Ajuste fino para o input de checkbox */
        .form-group label[for="diariaDobrou"] {
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
            margin-bottom: 0;
        }
        #diariaDobrou {
            vertical-align: middle;
            margin-top: 0;
        }

        /* Estilos específicos para o resumo do relatório na tela */
        .report-summary-section {
            margin-top: calc(var(--spacing-unit) * 1.5);
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            padding-top: calc(var(--spacing-unit) * 0.5);
            border-top: 1px solid var(--color-background-medium);
        }
        .report-summary-section h3 {
            border-bottom: none;
            text-align: left;
            margin-bottom: calc(var(--spacing-unit) * 0.5);
            padding-bottom: 0;
            color: var(--color-text-dark);
        }
        .report-summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        .report-summary-table th, .report-summary-table td {
            border: 1px solid var(--color-background-medium);
            padding: calc(var(--spacing-unit) * 0.5);
            text-align: left;
        }
        .report-summary-table thead th {
            background-color: var(--color-primary);
            color: var(--color-text-on-primary);
            font-weight: 600;
            text-transform: uppercase;
        }
        .report-summary-table.payments-table thead th {
            background-color: var(--color-primary);
        }
        .report-summary-table.expenses-table thead th {
            background-color: var(--color-success);
        }
        .report-summary-table tbody tr:nth-child(even) {
            background-color: var(--color-background-light);
        }
        .report-summary-table tbody tr:hover {
            background-color: #e2e6ea;
        }
        .report-summary-table tfoot tr {
            background-color: var(--color-text-dark);
            color: var(--color-text-on-primary);
            font-weight: bold;
        }
        .report-summary-table td.text-right {
            text-align: right;
        }
        .report-summary-table th.text-right {
            text-align: right;
        }
        .report-summary-table td.text-left {
            text-align: left;
        }

        /* Botões de Relatório (PDF e XLSX) */
        .report-buttons {
            display: flex;
            gap: var(--spacing-unit);
            margin-top: var(--spacing-unit);
            flex-wrap: wrap; /* Para mobile */
        }
        .report-buttons button {
            flex: 1; /* Ocupa espaço igualmente */
        }
        @media (min-width: 768px) {
            .report-buttons button {
                flex: none; /* Em desktop, volta a ser o tamanho do conteúdo */
                width: auto;
            }
        }

        /* Estilos do Modal (para Edição de Diária) */
        .modal {
            /* CORRIGIDO: display: none por padrão, será ativado via JS */
            display: none; 
            position: fixed; /* Fica por cima de tudo */
            z-index: 1000; /* Z-index alto para ficar na frente */
            left: 0;
            top: 0;
            width: 100%; /* Largura total */
            height: 100%; /* Altura total */
            overflow: auto; /* Habilita scroll se conteúdo for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo semi-transparente */
            align-items: center;
            justify-content: center;
        }
        /* NOVA CLASSE: Para ativar a exibição do modal via JS */
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: var(--color-surface);
            margin: auto;
            padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius-soft);
            box-shadow: var(--shadow-medium);
            width: 90%;
            max-width: 500px; /* Largura máxima para o modal */
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-background-medium);
            padding-bottom: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
        }
        .modal-header h2 {
            margin: 0;
            color: var(--color-primary);
            text-align: left; /* Títulos do modal alinhados à esquerda */
            font-size: 1.5rem;
        }
        .close-button {
            color: var(--color-text-muted);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            margin-left: var(--spacing-unit); /* Espaçamento do título */
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--color-primary);
            text-decoration: none;
            cursor: pointer;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end; /* Alinha botões à direita */
            gap: var(--spacing-unit);
            margin-top: calc(var(--spacing-unit) * 1.5);
        }

        /* Estilos para a nova tela de Regras de Pagamento */
        .regra-item {
            background-color: var(--color-background-light);
            border: 1px solid var(--color-background-medium);
            border-radius: var(--border-radius-soft);
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 0.5);
        }
        .regra-item strong {
            font-size: 1.1rem;
            color: var(--color-primary);
            margin-bottom: calc(var(--spacing-unit) * 0.5);
            display: block;
        }
        .regra-item .regra-fields {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-unit);
        }
        .regra-item .regra-fields .form-group {
            flex: 1 1 calc(50% - var(--spacing-unit) / 2); /* 2 colunas em telas maiores */
            min-width: 150px; /* Garante que não fique muito pequeno */
        }
        @media (min-width: 768px) {
            .regra-item .regra-fields .form-group {
                flex: 1 1 calc(33.33% - var(--spacing-unit) * 2 / 3); /* 3 colunas em desktop */
            }
        }
        .regra-item .regra-buttons {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-unit);
            margin-top: calc(var(--spacing-unit) * 0.5);
        }
        /* Esconder campos para tipos de cálculo que não os usam */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="mainContainer" class="container">

        <div id="screenLogin" class="screen active">
            <div class="login-wrapper">
                <h1 class="app-title">Sistema de Diárias</h1>
                <div class="card">
                    <h2>Login</h2>
                    <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail"></div>
                    <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword"></div>
                    <button class="btn-primary" id="loginButton" style="width: 100%;">Entrar</button>
                    <div id="loginErrorMessage"></div>
                </div>
            </div>
        </div>

        <div id="screenDashboard" class="screen">
            <div class="card">
                <div class="dashboard-header">
                    <div>
                        <h2>Painel de Controle</h2>
                        <p style="margin: 0; color: var(--color-text-muted);">Logado como: <strong id="userEmailDisplay" style="color: var(--color-text-dark);"></strong></p>
                    </div>
                    <button id="logoutButton" class="btn-secondary">Sair</button>
                </div>
                
                <div id="userMainPanel"> 
                    <h3>Opções do Sistema</h3>
                    <div class="admin-grid">
                        <button id="btnGoToLancarDiaria" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt-text">
                                <path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2Z"/>
                                <path d="M12 8h6"/>
                                <path d="M12 12h6"/>
                                <path d="M12 16h6"/>
                            </svg>
                            <span>Lançar Diárias</span>
                        </button>
                        <button id="btnGoToListarColaboradores" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <span>Colaboradores</span>
                        </button>
                        <button id="btnGoToRelatorios" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list">
                                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                <path d="M12 11h4"/>
                                <path d="M12 15h4"/>
                                <path d="M8 11h.01"/>
                                <path d="M8 15h.01"/>
                            </svg>
                            <span>Relatórios</span>
                        </button>
                        
                        <button id="btnGoToCriarLogin" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <line x1="19" x2="19" y1="8" y2="14"/>
                                <line x1="22" x2="16" y1="11" y2="11"/>
                            </svg>
                            <span>Criar Login</span>
                        </button>
                        
                        <button id="btnGoToListarLogins" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2">
                                <path d="M14 19a6 6 0 0 0-12 0"/>
                                <circle cx="8" cy="9" r="4"/>
                                <path d="M22 19a6 6 0 0 0-12 0"/>
                                <circle cx="16" cy="9" r="4"/>
                            </svg>
                            <span>Listar Logins</span>
                        </button>
                        
                        <button id="btnGoToAlterarSenha" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-key-round">
                                <path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h3v-3h3V9h3V6c0-.6-.4-1-1-1H9c-.6 0-1 .4-1 1v3H5v3H2Z"/>
                                <path d="M7 9h.01"/>
                            </svg>
                            <span>Alterar Senha</span>
                        </button>

                        <button id="btnGoToGerenciarDiarias" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-edit">
                                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                <path d="M9.5 16.5 16 10l-3.5-3.5L7 13l2.5 3.5Z"/>
                                <path d="M14.5 11.5 13 10"/>
                            </svg>
                            <span>Gerenciar Diárias</span>
                        </button>

                        <button id="btnGoToHistorico" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history">
                                <path d="M3 3v5h5"/>
                                <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>
                                <path d="M12 7v6h4"/>
                            </svg>
                            <span>Histórico</span>
                        </button>

                        <button id="btnGoToGerenciarRegras" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings">
                                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.35a2 2 0 0 0 .73 2.73l.04.02a2 2 0 0 1 .97 2.18v.44a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 0-.73 2.73l.78 1.35a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.35a2 2 0 0 0-.73-2.73l-.04-.02a2 2 0 0 1-.97-2.18v-.44a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 0 .73-2.73l-.78-1.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            <span>Regras de Diária</span>
                        </button>

                    </div>
                </div>
            </div>
        </div>

        <div id="screenAdicionarColaborador" class="screen"> 
            <button id="btnAdicionarColabVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar à Lista</button> 
            <div class="card"> 
                <h2>Adicionar / Editar Colaborador</h2> 
                <div class="card"> 
                    <h3 id="colaboradorFormTitle">Adicionar Novo Colaborador</h3> 
                    <div class="form-group"><label for="colabNome">Nome Completo:</label><input type="text" id="colabNome" ></div> 
                    <div class="form-group">
                        <label for="colabFuncao">Função:</label>
                        <select id="colabFuncao">
                            <option value="">-- Selecione a Função --</option>
                            </select>
                    </div> 
                    <div class="form-group">
                        <label for="colabSetor">Setor:</label>
                        <select id="colabSetor">
                            <option value="">-- Selecione o Setor --</option>
                            <option value="Cozinha">Cozinha</option>
                            <option value="Salão">Salão</option>
                            <option value="ADM">ADM</option>
                            <option value="ASG">ASG</option>
                            <option value="Recreação">Recreação</option>
                        </select>
                    </div> 
                    <div class="form-group"><label for="colabPix">Chave PIX:</label><input type="text" id="colabPix" ></div> 
                    <div class="form-group"><label for="colabCpf">CPF:</label><input type="text" id="colabCpf" placeholder="Ex: 000.000.000-00"></div>
                    <div class="form-group"><label for="colabTelefone">Telefone:</label><input type="tel" id="colabTelefone" placeholder="Ex: (00) 90000-0000"></div>
                    <div class="form-group"><label for="colabEndereco">Endereço:</label><input type="text" id="colabEndereco" placeholder="Rua, Número, Bairro, Cidade-UF"></div>
                    <div class="form-group"><label for="colabDataNascimento">Data de Nascimento:</label><input type="date" id="colabDataNascimento"></div>
                    <div class="form-group"><label for="colabNomeMae">Nome da Mãe:</label><input type="text" id="colabNomeMae"></div>
                    <button id="btnSalvarColaborador" class="btn-success">Salvar Novo Colaborador</button> 
                </div> 
            </div> 
        </div>

        <div id="screenListarColaboradores" class="screen">
            <button id="btnListarColabVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Colaboradores Cadastrados</h2>
                <button id="btnGoToAdicionarColaborador" class="btn-primary" style="margin-bottom: var(--spacing-unit);">+ Adicionar Novo Colaborador</button>
                <div class="table-responsive"> 
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome Completo</th>
                                <th>Função</th>
                                <th>Setor</th>
                                <th>Chave PIX</th>
                                <th>CPF</th>
                                <th>Telefone</th>
                                <th>Endereço</th>
                                <th>Nasc.</th>
                                <th>Nome Mãe</th>
                                <th>Ações</th> </tr>
                        </thead>
                        <tbody id="colaboradoresTableBody">
                            <tr><td colspan="10" style="text-align: center; padding: 20px;">Carregando colaboradores...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenLancarDiarias" class="screen">
             <button id="btnLancarDiariasVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
             <div class="card">
                 <h2>Lançamento de Diárias</h2>
                 <div class="form-group">
                     <label for="diariaColaborador">Colaborador:</label>
                     <select id="diariaColaborador"></select>
                 </div>
                 <div class="form-row">
                     <div class="form-group">
                         <label for="diariaFuncao">Função:</label>
                         <input type="text" id="diariaFuncao" readonly>
                     </div>
                     <div class="form-group">
                         <label for="diariaSetor">Setor:</label>
                         <input type="text" id="diariaSetor" readonly>
                     </div>
                 </div>
                 <div class="form-group">
                     <label for="diariaData">Data da Diária:</label>
                     <input type="date" id="diariaData">
                 </div>
                 
                 <div id="diariaCamposDinamicos" style="display:none; border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                     <div class="form-group">
                         <label for="diariaDobrou" style="display: inline-block; margin-right: 10px;">Dobrou o turno?</label>
                         <input type="checkbox" id="diariaDobrou">
                     </div>
                     <div class="form-row" id="diariaHorasContainer">
                         <div class="form-group">
                             <label for="diariaHoraEntrada">Horário de Entrada:</label>
                             <input type="time" id="diariaHoraEntrada">
                         </div>
                         <div class="form-group">
                             <label for="diariaHoraSaida">Horário de Saída:</label>
                             <input type="time" id="diariaHoraSaida">
                         </div>
                     </div>
                 </div>
                  <button id="btnSalvarDiaria" class="btn-success" style="width: 100%;">Lançar Diária</button>
             </div>
        </div>

        <div id="screenRelatorios" class="screen">
            <button id="btnRelatoriosVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Gerar Relatório de Diárias</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="relatorioDataInicio">Data Início:</label>
                        <input type="date" id="relatorioDataInicio">
                    </div>
                    <div class="form-group">
                        <label for="relatorioDataFim">Data Fim:</label>
                        <input type="date" id="relatorioDataFim">
                    </div>
                </div>
                <div class="report-buttons">
                    <button id="btnVerResumo" class="btn-primary">Ver Resumo na Tela</button>
                    <button id="btnGerarRelatorioPdf" class="btn-primary">Gerar PDF</button>
                    <button id="btnGerarRelatorioXlsx" class="btn-success">Gerar XLSX</button>
                </div>

                <div id="resumoPagamentos" class="report-summary-section" style="display: none;">
                    <h3>Pagamentos por Colaborador</h3>
                    <div class="table-responsive">
                        <table class="report-summary-table payments-table">
                            <thead><tr><th>Nome Completo</th><th>Chave PIX</th><th class="text-right">Valor Total</th></tr></thead>
                            <tbody id="resumoPagamentosBody"></tbody>
                            <tfoot><tr><td colspan="2" class="text-left">Total Geral</td><td id="resumoPagamentosTotal" class="text-right"></td></tr></tfoot>
                        </table>
                    </div>
                </div>

                <div id="resumoGastos" class="report-summary-section" style="display: none;">
                    <h3>Gastos por Setor</h3>
                    <div class="table-responsive">
                        <table class="report-summary-table expenses-table">
                            <thead><tr><th>Setor</th><th class="text-right">Valor Total</th></tr></thead>
                            <tbody id="resumoGastosBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="screenCriarLogin" class="screen">
            <button id="btnCriarLoginVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Criar Novo Acesso</h2>
                <div class="form-group"><label for="createUserEmail">Email:</label><input type="email" id="createUserEmail"></div>
                <div class="form-group"><label for="generatedPasswordDisplay">Senha Gerada:</label><input type="text" id="generatedPasswordDisplay" readonly></div>
                <button class="btn-primary" id="btnCreateUser" style="width: 100%;">Gerar Senha e Criar Usuário</button>
                <div id="createUserErrorMessage"></div>
            </div>
        </div>

        <div id="screenListarLogins" class="screen">
            <button id="btnListarLoginsVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Logins Cadastrados</h2>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="1" style="text-align: center; padding: 20px;">Carregando usuários...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="listarLoginsMessage" style="display:none; color: var(--color-text-dark); margin-top: 1rem;"></div>
            </div>
        </div>

        <div id="screenAlterarSenha" class="screen">
            <button id="btnAlterarSenhaVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Alterar Minha Senha</h2>
                <div class="form-group"><label for="currentPassword">Senha Atual:</label><input type="password" id="currentPassword"></div>
                <div class="form-group"><label for="newPassword">Nova Senha:</label><input type="password" id="newPassword"></div>
                <div class="form-group"><label for="confirmNewPassword">Confirmar Nova Senha:</label><input type="password" id="confirmNewPassword"></div>
                <button class="btn-primary" id="btnChangePassword" style="width: 100%;">Alterar Senha</button>
                <div id="changePasswordErrorMessage"></div>
            </div>
        </div>

        <div id="screenGerenciarDiarias" class="screen">
            <button id="btnGerenciarDiariasVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Gerenciar Diárias Lançadas</h2>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Colaborador</th> <th>Data</th>
                                <th>Função</th>
                                <th>Setor</th>
                                <th>Valor</th>
                                <th>Lançado Por</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="gerenciarDiariasTableBody">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">Carregando diárias...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="editDiariaModal" class="modal"> 
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Editar Diária</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editDiariaId">
                        <div class="form-group"><label for="editDiariaColaboradorNome">Colaborador:</label><input type="text" id="editDiariaColaboradorNome" readonly></div>
                        <div class="form-group"><label for="editDiariaData">Data da Diária:</label><input type="date" id="editDiariaData"></div>
                        <div class="form-group">
                            <label for="editDiariaFuncao">Função:</label>
                            <select id="editDiariaFuncao">
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="editDiariaSetor">Setor:</label>
                            <select id="editDiariaSetor">
                                <option value="Cozinha">Cozinha</option>
                                <option value="Salão">Salão</option>
                                <option value="ADM">ADM</option>
                                <option value="ASG">ASG</option>
                                <option value="Recreação">Recreação</option>
                            </select>
                        </div>
                        <div id="editDiariaCamposDinamicos" style="display: none;"> 
                            <div class="form-group">
                                <label for="editDiariaDobrou" style="display: inline-block; margin-right: 10px;">Dobrou o turno?</label>
                                <input type="checkbox" id="editDiariaDobrou">
                            </div>
                            <div class="form-row" id="editDiariaHorasContainer">
                                <div class="form-group">
                                    <label for="editDiariaHoraEntrada">Horário de Entrada:</label>
                                    <input type="time" id="editDiariaHoraEntrada">
                                </div>
                                <div class="form-group">
                                    <label for="editDiariaHoraSaida">Horário de Saída:</label>
                                    <input type="time" id="editDiariaHoraSaida">
                                </div>
                            </div>
                        </div>
                        <div class="form-group"><label for="editDiariaValorPago">Valor Calculado:</label><input type="text" id="editDiariaValorPago" readonly></div>
                    </div>
                    <div class="modal-buttons">
                        <button class="btn-secondary" id="cancelEditDiaria">Cancelar</button>
                        <button class="btn-primary" id="saveEditDiaria">Salvar Alterações</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screenHistorico" class="screen">
            <button id="btnHistoricoVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Histórico de Diárias</h2>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Ação</th>
                                <th>Diária ID</th> <th>Usuário</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="historicoTableBody">
                            <tr><td colspan="5" style="text-align: center; padding: 20px;">Carregando histórico...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenGerenciarRegras" class="screen">
            <button id="btnGerenciarRegrasVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Gerenciar Regras de Pagamento</h2>
                <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-unit);">
                    Ajuste aqui os valores e as regras de cálculo para cada função.
                </p>
                <div id="regrasPagamentoList">
                    <p style="text-align: center; padding: 20px;">Carregando regras de pagamento...</p>
                </div>
            </div>
        </div>

        <div id="screenRelatorioColaboradores" class="screen">
            <button id="btnRelatorioColaboradoresVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Relatório de Colaboradores Cadastrados</h2>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome Completo</th>
                                <th>Função</th>
                                <th>Setor</th>
                                <th>Chave PIX</th>
                                <th>CPF</th>
                                <th>Telefone</th>
                                <th>Endereço</th>
                                <th>Nasc.</th>
                                <th>Nome Mãe</th>
                            </tr>
                        </thead>
                        <tbody id="relatorioColaboradoresTableBody">
                            <tr><td colspan="9" style="text-align: center; padding: 20px;">Carregando colaboradores...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="report-buttons" style="margin-top: 1.5rem;">
                    <button id="btnGerarRelatorioColaboradoresPdf" class="btn-primary">Gerar PDF dos Colaboradores</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // SUAS CREDENCIAIS SUPABASE AQUI!
            const SUPABASE_URL = 'https://pbgnhcwspgvqcwlbbxle.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZ25oY3dzcGd2cWN3bGJieGxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNTQwNjksImV4cCI6MjA2NjkzMDA2OX0.9wOVZGObGwmL5T1qLkxOA2Ktm9TmW-zBPQnyn94vYSo';
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            let currentUser = null;
            let colaboradoresCache = []; // Cache de colaboradores para evitar múltiplas chamadas
            let diariasCache = []; // Cache de diárias para edição/exclusão
            let regrasPagamentoCache = []; // NOVO: Cache para regras de pagamento
            
            const { jsPDF } = window.jspdf;
            const XLSX = window.XLSX; // Garantir que XLSX está globalmente acessível

            // --- DOM SELECTORS ---
            const screens = {
                login: document.getElementById('screenLogin'), 
                dashboard: document.getElementById('screenDashboard'),
                adicionarColaborador: document.getElementById('screenAdicionarColaborador'), 
                listarColaboradores: document.getElementById('screenListarColaboradores'), 
                lancarDiarias: document.getElementById('screenLancarDiarias'),
                relatorios: document.getElementById('screenRelatorios'),
                criarLogin: document.getElementById('screenCriarLogin'),
                listarLogins: document.getElementById('screenListarLogins'), 
                alterarSenha: document.getElementById('screenAlterarSenha'),
                gerenciarDiarias: document.getElementById('screenGerenciarDiarias'), 
                historico: document.getElementById('screenHistorico'),
                gerenciarRegras: document.getElementById('screenGerenciarRegras'), // Nova tela de regras
                relatorioColaboradores: document.getElementById('screenRelatorioColaboradores') // Nova tela de relatório de colaboradores
            };

            const loginEmailInput = document.getElementById('loginEmail'), loginPasswordInput = document.getElementById('loginPassword'), loginButton = document.getElementById('loginButton'), loginErrorMessage = document.getElementById('loginErrorMessage');
            const logoutButton = document.getElementById('logoutButton'), userEmailDisplay = document.getElementById('userEmailDisplay');
            const userMainPanel = document.getElementById('userMainPanel'); 
            
            // Colaboradores
            const btnGoToListarColaboradores = document.getElementById('btnGoToListarColaboradores'); 
            const btnGoToAdicionarColaborador = document.getElementById('btnGoToAdicionarColaborador'); 
            const btnAdicionarColabVoltar = document.getElementById('btnAdicionarColabVoltar'); 
            const btnListarColabVoltar = document.getElementById('btnListarColabVoltar'); 
            const colaboradorFormTitle = document.getElementById('colaboradorFormTitle'); 

            const btnSalvarColaborador = document.getElementById('btnSalvarColaborador');
            const colabNomeInput = document.getElementById('colabNome');
            const colabFuncaoSelect = document.getElementById('colabFuncao'); 
            const colabSetorSelect = document.getElementById('colabSetor'); 
            const colabPixInput = document.getElementById('colabPix');
            const colabCpfInput = document.getElementById('colabCpf'), colabTelefoneInput = document.getElementById('colabTelefone'), colabEnderecoInput = document.getElementById('colabEndereco');
            const colabDataNascimentoInput = document.getElementById('colabDataNascimento'), colabNomeMaeInput = document.getElementById('colabNomeMae'); // NOVOS DOM
            const colaboradoresTableBody = document.getElementById('colaboradoresTableBody');
            
            // Lançar Diárias
            const btnGoToLancarDiaria = document.getElementById('btnGoToLancarDiaria');
            const btnLancarDiariasVoltar = document.getElementById('btnLancarDiariasVoltar'); 
            const btnSalvarDiaria = document.getElementById('btnSalvarDiaria');
            const diariaColaboradorSelect = document.getElementById('diariaColaborador'), diariaFuncaoInput = document.getElementById('diariaFuncao'), diariaSetorInput = document.getElementById('diariaSetor'), diariaDataInput = document.getElementById('diariaData'), diariaCamposDinamicos = document.getElementById('diariaCamposDinamicos'), diariaDobrouCheckbox = document.getElementById('diariaDobrou'), diariaHorasContainer = document.getElementById('diariaHorasContainer'), diariaHoraEntradaInput = document.getElementById('diariaHoraEntrada'), diariaHoraSaidaInput = document.getElementById('diariaHoraSaida');
            
            // Relatórios
            const btnGoToRelatorios = document.getElementById('btnGoToRelatorios');
            const btnRelatoriosVoltar = document.getElementById('btnRelatoriosVoltar');
            const relatorioDataInicioInput = document.getElementById('relatorioDataInicio');
            const relatorioDataFimInput = document.getElementById('relatorioDataFim');
            const btnVerResumo = document.getElementById('btnVerResumo'); 
            const btnGerarRelatorioPdf = document.getElementById('btnGerarRelatorioPdf');
            const btnGerarRelatorioXlsx = document.getElementById('btnGerarRelatorioXlsx'); 
            const resumoPagamentosDiv = document.getElementById('resumoPagamentos'); 
            const resumoPagamentosBody = document.getElementById('resumoPagamentosBody'); 
            const resumoPagamentosTotal = document.getElementById('resumoPagamentosTotal'); 
            const resumoGastosDiv = document.getElementById('resumoGastos'); 
            const resumoGastosBody = document.getElementById('resumoGastosBody'); 

            // Criar Login
            const btnGoToCriarLogin = document.getElementById('btnGoToCriarLogin');
            const btnCriarLoginVoltar = document.getElementById('btnCriarLoginVoltar');
            const createUserEmailInput = document.getElementById('createUserEmail');
            const generatedPasswordDisplay = document.getElementById('generatedPasswordDisplay'); 
            const btnCreateUser = document.getElementById('btnCreateUser');
            const createUserErrorMessage = document.getElementById('createUserErrorMessage');

            // Listar Logins
            const btnGoToListarLogins = document.getElementById('btnGoToListarLogins');
            const btnListarLoginsVoltar = document.getElementById('btnListarLoginsVoltar');
            const usersTableBody = document.getElementById('usersTableBody');
            const listarLoginsMessage = document.getElementById('listarLoginsMessage');

            // Alterar Senha
            const btnGoToAlterarSenha = document.getElementById('btnGoToAlterarSenha');
            const btnAlterarSenhaVoltar = document.getElementById('btnAlterarSenhaVoltar');
            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
            const btnChangePassword = document.getElementById('btnChangePassword');
            const changePasswordErrorMessage = document.getElementById('changePasswordErrorMessage');

            // Gerenciar Diárias
            const btnGoToGerenciarDiarias = document.getElementById('btnGoToGerenciarDiarias');
            const btnGerenciarDiariasVoltar = document.getElementById('btnGerenciarDiariasVoltar');
            const gerenciarDiariasTableBody = document.getElementById('gerenciarDiariasTableBody');

            // Modal de Edição de Diária
            const editDiariaModal = document.getElementById('editDiariaModal');
            const closeEditModalButton = editDiariaModal.querySelector('.close-button');
            const cancelEditDiariaButton = document.getElementById('cancelEditDiaria');
            const saveEditDiariaButton = document.getElementById('saveEditDiaria');
            const editDiariaIdInput = document.getElementById('editDiariaId');
            const editDiariaColaboradorNomeInput = document.getElementById('editDiariaColaboradorNome');
            const editDiariaDataInput = document.getElementById('editDiariaData');
            const editDiariaFuncaoSelect = document.getElementById('editDiariaFuncao');
            const editDiariaSetorSelect = document.getElementById('editDiariaSetor');
            const editDiariaDobrouCheckbox = document.getElementById('editDiariaDobrou');
            const editDiariaCamposDinamicos = document.getElementById('editDiariaCamposDinamicos');
            const editDiariaHorasContainer = document.getElementById('editDiariaHorasContainer');
            const editDiariaHoraEntradaInput = document.getElementById('editDiariaHoraEntrada');
            const editDiariaHoraSaidaInput = document.getElementById('editDiariaHoraSaida');
            const editDiariaValorPagoInput = document.getElementById('editDiariaValorPago');

            // Histórico
            const btnGoToHistorico = document.getElementById('btnGoToHistorico');
            const btnHistoricoVoltar = document.getElementById('btnHistoricoVoltar');
            const historicoTableBody = document.getElementById('historicoTableBody');

            // NOVA TELA: Gerenciamento de Regras de Pagamento
            const btnGoToGerenciarRegras = document.getElementById('btnGoToGerenciarRegras');
            const btnGerenciarRegrasVoltar = document.getElementById('btnGerenciarRegrasVoltar');
            const regrasPagamentoList = document.getElementById('regrasPagamentoList');
            
            // Relatório de Colaboradores (NOVOS DOM)
            const btnGoToRelatorioColaboradores = document.getElementById('btnGoToRelatorioColaboradores');
            const btnRelatorioColaboradoresVoltar = document.getElementById('btnRelatorioColaboradoresVoltar');
            const relatorioColaboradoresTableBody = document.getElementById('relatorioColaboradoresTableBody');
            const btnGerarRelatorioColaboradoresPdf = document.getElementById('btnGerarRelatorioColaboradoresPdf');

            // ID do administrador mestre (ATUALIZE ESTE ID com o do seu usuário admin no Supabase!)
            // Isso controla a VISIBILIDADE dos botões de ADMIN no frontend.
            // A SEGURANÇA REAL das operações é controlada pelas Políticas de RLS no Supabase!
            const ADMIN_USER_ID = 'a37a896b-0b5a-4b87-b8be-3358249a84ee'; 

            // --- CORE FUNCTIONS ---
            function showScreen(screenId) {
                Object.values(screens).forEach(screen => {
                    screen.classList.remove('active');
                });
                if (screens[screenId]) {
                    screens[screenId].classList.add('active');
                } else {
                    console.error(`Tela com ID '${screenId}' não encontrada.`);
                }
            }

            async function handleLogin() {
                loginErrorMessage.style.display = 'none';
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;

                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    loginErrorMessage.textContent = `Erro de login: ${error.message}`;
                    loginErrorMessage.style.display = 'block';
                } else if (data.user) {
                    await setupDashboard(data.user);
                }
            }

            async function setupDashboard(user) {
                currentUser = user;
                userEmailDisplay.textContent = user.email;

                // Visibilidade de botões de ADMIN (controlada por RLS no backend para segurança real)
                if (user.id === ADMIN_USER_ID) { 
                    btnGoToCriarLogin.style.display = 'flex'; 
                    btnGoToListarLogins.style.display = 'flex';
                    btnGoToGerenciarDiarias.style.display = 'flex'; 
                    btnGoToHistorico.style.display = 'flex'; 
                    btnGoToGerenciarRegras.style.display = 'flex'; // Botão de Regras visível para Admin
                    btnGoToRelatorioColaboradores.style.display = 'flex'; // Botão de Relatório de Colaboradores visível para Admin
                } else {
                    btnGoToCriarLogin.style.display = 'none';
                    btnGoToListarLogins.style.display = 'none';
                    btnGoToGerenciarDiarias.style.display = 'none'; 
                    btnGoToHistorico.style.display = 'none'; 
                    btnGoToGerenciarRegras.style.display = 'none';
                    btnGoToRelatorioColaboradores.style.display = 'none';
                }
                btnGoToAlterarSenha.style.display = 'flex'; 

                showScreen('dashboard');
            }

            async function handleLogout() {
                const { error } = await _supabase.auth.signOut();
                if (error) {
                    console.error("Erro ao fazer logout:", error.message);
                    alert("Erro ao sair. Tente novamente.");
                } else {
                    currentUser = null;
                    showScreen('login');
                    loginEmailInput.value = '';
                    loginPasswordInput.value = '';
                    loginErrorMessage.style.display = 'none';
                }
            }

            // --- NOVO: Função para carregar Regras de Pagamento ---
            async function fetchRegrasPagamento() {
                const { data, error } = await _supabase.from('regras_pagamento').select('*').order('funcao');
                if (error) {
                    console.error("Erro ao buscar regras de pagamento:", error);
                    alert("Erro ao carregar regras de pagamento.");
                    return [];
                }
                regrasPagamentoCache = data;

                // Preencher selects de função nos formulários
                const funcoesUnicas = [...new Set(regrasPagamentoCache.map(r => r.funcao))].sort();
                colabFuncaoSelect.innerHTML = '<option value="">-- Selecione a Função --</option>';
                editDiariaFuncaoSelect.innerHTML = '<option value="">-- Selecione a Função --</option>';
                funcoesUnicas.forEach(funcao => {
                    colabFuncaoSelect.innerHTML += `<option value="${funcao}">${funcao}</option>`;
                    editDiariaFuncaoSelect.innerHTML += `<option value="${funcao}">${funcao}</option>`;
                });

                return data;
            }


            // --- COLABORADORES: LISTAGEM, ADIÇÃO E EDIÇÃO ---

            // Função para renderizar a tabela de colaboradores
            function renderColaboradores() {
                colaboradoresTableBody.innerHTML = '';
                if (colaboradoresCache.length === 0) {
                    // Colspan ajustado para 10 (8 campos existentes + Nasc. + Nome Mãe + Ações)
                    colaboradoresTableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Nenhum colaborador cadastrado.</td></tr>';
                    return;
                }
                colaboradoresCache.forEach(colab => {
                    const row = colaboradoresTableBody.insertRow();
                    row.innerHTML = `
                        <td>${colab.nome_completo}</td>
                        <td>${colab.funcao}</td>
                        <td>${colab.setor}</td>
                        <td>${colab.chave_pix || 'N/A'}</td>
                        <td>${formatCpf(colab.cpf) || 'N/A'}</td>
                        <td>${formatTelefone(colab.telefone) || 'N/A'}</td>
                        <td>${colab.endereco || 'N/A'}</td>
                        <td>${colab.data_nascimento ? new Date(colab.data_nascimento).toLocaleDateString('pt-BR') : 'N/A'}</td>
                        <td>${colab.nome_mae || 'N/A'}</td>
                        <td>
                            <button class="btn-secondary btn-sm" data-action="edit" data-id="${colab.id}" style="padding: 5px 10px; font-size: 0.8rem;">Editar</button>
                        </td>
                        `;
                });

                // Adiciona listeners para os botões de editar (e futuramente excluir)
                colaboradoresTableBody.querySelectorAll('button[data-action="edit"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        handleEditarColaborador(id);
                    });
                });
            }

            // Função para buscar colaboradores e renderizar
            async function fetchAndRenderColaboradores() {
                const { data, error } = await _supabase.from('colaboradores').select('*').order('nome_completo');
                if (error) {
                    console.error("Erro ao buscar colaboradores:", error);
                    alert("Erro ao carregar colaboradores.");
                    return;
                }
                colaboradoresCache = data;
                renderColaboradores();
            }

            // Função para lidar com o salvamento/atualização de colaborador
            let editingColaboradorId = null; 
            async function handleSalvarColaborador() {
                const nome = colabNomeInput.value.trim();
                const funcao = colabFuncaoSelect.value.trim(); 
                const setor = colabSetorSelect.value.trim();
                const pix = colabPixInput.value.trim();
                const cpf = colabCpfInput.value.replace(/\D/g, ''); // Remove não dígitos para salvar
                const telefone = colabTelefoneInput.value.replace(/\D/g, ''); // Remove não dígitos para salvar
                const endereco = colabEnderecoInput.value.trim();
                const dataNascimento = colabDataNascimentoInput.value; // Novo campo
                const nomeMae = colabNomeMaeInput.value.trim(); // Novo campo

                // Validação de campos obrigatórios
                if (!nome) { alert('O campo "Nome Completo" é obrigatório.'); return; }
                if (funcao === "") { alert('Por favor, selecione uma função válida.'); return; }
                if (setor === "") { alert('Por favor, selecione um setor válido.'); return; }
                if (!pix) { alert('O campo "Chave PIX" é obrigatório.'); return; }
                if (!cpf) { alert('O campo "CPF" é obrigatório.'); return; }

                let response;
                try {
                    if (editingColaboradorId) {
                        // Modo edição
                        response = await _supabase.from('colaboradores')
                            .update({ 
                                nome_completo: nome, 
                                funcao: funcao, 
                                setor: setor, 
                                chave_pix: pix,
                                cpf: cpf,
                                telefone: telefone,
                                endereco: endereco,
                                data_nascimento: dataNascimento || null, // Salva como null se vazio
                                nome_mae: nomeMae || null // Salva como null se vazio
                            })
                            .eq('id', editingColaboradorId)
                            .select();
                    } else {
                        // Modo adição
                        response = await _supabase.from('colaboradores').insert([
                            { 
                                nome_completo: nome, 
                                funcao: funcao, 
                                setor: setor, 
                                chave_pix: pix,
                                cpf: cpf,
                                telefone: telefone,
                                endereco: endereco,
                                data_nascimento: dataNascimento || null,
                                nome_mae: nomeMae || null,
                                ativo: true 
                            }
                        ]).select();
                    }

                    const { data, error } = response;

                    if (error) {
                        if (error.code === '23505' && error.constraint === 'unique_cpf') {
                            alert(`Erro: O CPF ${formatCpf(cpf)} já está cadastrado.`);
                        } else {
                            alert(`Erro ao salvar/atualizar colaborador: ${error.message}`);
                            console.error("Erro no salvamento/atualização do colaborador:", error);
                        }
                    } else {
                        alert(`Colaborador ${editingColaboradorId ? 'atualizado' : 'salvo'} com sucesso!`);
                        // Limpar formulário e estado de edição
                        colabNomeInput.value = '';
                        colabFuncaoSelect.value = ''; 
                        colabSetorSelect.value = ''; 
                        colabPixInput.value = '';
                        colabCpfInput.value = '';
                        colabTelefoneInput.value = '';
                        colabEnderecoInput.value = '';
                        colabDataNascimentoInput.value = '';
                        colabNomeMaeInput.value = '';
                        
                        editingColaboradorId = null;
                        colaboradorFormTitle.textContent = 'Adicionar Novo Colaborador';
                        btnSalvarColaborador.textContent = 'Salvar Novo Colaborador';
                        btnSalvarColaborador.classList.remove('btn-primary'); 
                        btnSalvarColaborador.classList.add('btn-success');

                        showScreen('listarColaboradores'); // Volta para a lista
                        fetchAndRenderColaboradores(); // Recarrega a lista
                    }
                } catch (e) {
                    alert(`Ocorreu um erro inesperado: ${e.message}`);
                    console.error("Erro inesperado em handleSalvarColaborador:", e);
                }
            }

            // Função para lidar com a edição de colaborador
            async function handleEditarColaborador(id) {
                const colaborador = colaboradoresCache.find(colab => colab.id === id);
                if (!colaborador) {
                    alert('Colaborador não encontrado para edição.');
                    return;
                }

                editingColaboradorId = id;
                colabNomeInput.value = colaborador.nome_completo;
                colabFuncaoSelect.value = colaborador.funcao;
                colabSetorSelect.value = colaborador.setor;
                colabPixInput.value = colaborador.chave_pix || '';
                colabCpfInput.value = formatCpf(colaborador.cpf) || ''; // Formata para exibição
                colabTelefoneInput.value = formatTelefone(colaborador.telefone) || ''; // Formata para exibição
                colabEnderecoInput.value = colaborador.endereco || '';
                colabDataNascimentoInput.value = colaborador.data_nascimento || '';
                colabNomeMaeInput.value = colaborador.nome_mae || '';

                colaboradorFormTitle.textContent = 'Editar Colaborador Existente';
                btnSalvarColaborador.textContent = 'Atualizar Colaborador';
                btnSalvarColaborador.classList.remove('btn-success');
                btnSalvarColaborador.classList.add('btn-primary'); 
                
                showScreen('adicionarColaborador'); // Vai para a tela de formulário
            }

            // --- Lançamento de Diárias - Lógica de Cálculo e Exibição ---
            
            // Função de cálculo de valor da diária (reutilizada para edição)
            function calculateAndSetDiariaValue(isEditContext = false) {
                const currentDiariaFuncaoSelect = isEditContext ? editDiariaFuncaoSelect : diariaFuncaoInput; 
                const currentDiariaDobrouCheckbox = isEditContext ? editDiariaDobrouCheckbox : diariaDobrouCheckbox;
                const currentDiariaHoraEntradaInput = isEditContext ? editDiariaHoraEntradaInput : diariaHoraEntradaInput;
                const currentDiariaHoraSaidaInput = isEditContext ? editDiariaHoraSaidaInput : diariaHoraSaidaInput;
                const currentDiariaValorPagoInput = isEditContext ? editDiariaValorPagoInput : null; 

                const funcao = currentDiariaFuncaoSelect.value;
                const dobrou = currentDiariaDobrouCheckbox.checked;
                const horaEntrada = currentDiariaHoraEntradaInput.value;
                const horaSaida = currentDiariaHoraSaidaInput.value;
                
                let valorCalculado = 0;
                let horasTrabalhadas = null;

                const regra = regrasPagamentoCache.find(r => r.funcao === funcao);

                if (!regra) {
                    if (currentDiariaValorPagoInput) currentDiariaValorPagoInput.value = 'R$ 0,00';
                    console.warn(`Regra de pagamento não encontrada para a função: ${funcao}`);
                    return { valorCalculado: 0, horasTrabalhadas: null }; 
                }

                const dataReferencia = isEditContext ? editDiariaDataInput.value : diariaDataInput.value;
                let isWeekend = false;
                if (dataReferencia) {
                    const dataObj = new Date(dataReferencia + 'T00:00:00'); 
                    const diaDaSemana = dataObj.getDay(); 
                    isWeekend = (diaDaSemana === 6 || diaDaSemana === 0); 
                }

                switch (regra.tipo_calculo) {
                    case 'Fixo':
                        valorCalculado = regra.valor_base;
                        horasTrabalhadas = null;
                        break;
                    case 'Fixo com Dobra':
                        if (dobrou) {
                            valorCalculado = isWeekend ? regra.valor_dobra_fds : regra.valor_dobra_semana;
                            horasTrabalhadas = (regra.horas_base || 8) * 2; 
                        } else {
                            if (horaEntrada && horaSaida) {
                                const entradaMS = new Date(`1970-01-01T${horaEntrada}:00`).getTime();
                                const saidaMS = new Date(`1970-01-01T${horaSaida}:00`).getTime();
                                
                                if (saidaMS < entradaMS) { // Virada de dia
                                    horasTrabalhadas = ((24 * 60 * 60 * 1000) - entradaMS + saidaMS) / (1000 * 60 * 60);
                                } else {
                                    horasTrabalhadas = (saidaMS - entradaMS) / (1000 * 60 * 60);
                                }
                            } else {
                                horasTrabalhadas = 0; 
                            }

                            const basePay = regra.valor_base;
                            const baseHours = regra.horas_base || 8; 
                            const hourlyRate = regra.valor_hora_extra || 0; 

                            valorCalculado = (horasTrabalhadas <= baseHours) ? basePay : basePay + ((horasTrabalhadas - baseHours) * hourlyRate);
                        }
                        break;
                    default:
                        valorCalculado = 0;
                        horasTrabalhadas = null;
                        console.warn(`Tipo de cálculo desconhecido: ${regra.tipo_calculo}`);
                }
                
                if (currentDiariaValorPagoInput) {
                    currentDiariaValorPagoInput.value = `R$ ${valorCalculado.toFixed(2).replace('.', ',')}`;
                }
                return { valorCalculado: parseFloat(valorCalculado.toFixed(2)), horasTrabalhadas: horasTrabalhadas ? parseFloat(horasTrabalhadas.toFixed(2)) : null };
            }

            async function showLancarDiariasScreen() {
                const { data, error } = await _supabase.from('colaboradores').select('id, nome_completo, funcao, setor').eq('ativo', true).order('nome_completo');
                if(error) { console.error("Erro ao carregar colaboradores para lançamento de diária:", error); alert("Erro ao carregar colaboradores."); return; }
                colaboradoresCache = data;

                diariaColaboradorSelect.innerHTML = '<option value="">-- Selecione um Colaborador --</option>';
                colaboradoresCache.forEach(colab => {
                    diariaColaboradorSelect.innerHTML += `<option value="${colab.id}">${colab.nome_completo}</option>`;
                });
                
                diariaDataInput.valueAsDate = new Date(); 
                diariaCamposDinamicos.style.display = 'none';
                diariaFuncaoInput.value = ''; 
                diariaSetorInput.value = '';
                diariaHoraEntradaInput.value = '';
                diariaHoraSaidaInput.value = '';
                diariaDobrouCheckbox.checked = false;
                
                showScreen('lancarDiarias');
            }

            function toggleDiariaFields(isEditContext = false) {
                const selectedColabId = isEditContext ? editDiariaColaboradorNomeInput.dataset.colabId : diariaColaboradorSelect.value;
                const colaborador = colaboradoresCache.find(c => c.id == selectedColabId);
                
                const currentDiariaFuncaoInput = isEditContext ? editDiariaFuncaoSelect : diariaFuncaoInput;
                const currentDiariaSetorInput = isEditContext ? editDiariaSetorSelect : diariaSetorInput;
                const currentDiariaCamposDinamicos = isEditContext ? editDiariaCamposDinamicos : diariaCamposDinamicos;
                const currentDiariaHorasContainer = isEditContext ? editDiariaHorasContainer : diariaHorasContainer;
                const currentDiariaDobrouCheckbox = isEditContext ? editDiariaDobrouCheckbox : diariaDobrouCheckbox;

                if (!colaborador) {
                    currentDiariaCamposDinamicos.style.display = 'none'; 
                    currentDiariaFuncaoInput.value = '';
                    currentDiariaSetorInput.value = '';
                    if (isEditContext) editDiariaValorPagoInput.value = 'R$ 0,00';
                    return;
                }

                currentDiariaFuncaoInput.value = colaborador.funcao || '';
                currentDiariaSetorInput.value = colaborador.setor || '';
                
                const regra = regrasPagamentoCache.find(r => r.funcao === (colaborador.funcao || ''));

                if (regra && regra.tipo_calculo === 'Fixo com Dobra') {
                    currentDiariaCamposDinamicos.style.display = 'block';
                    currentDiariaHorasContainer.style.display = currentDiariaDobrouCheckbox.checked ? 'none' : 'flex';
                } else {
                    currentDiariaCamposDinamicos.style.display = 'none';
                }

                // Recalcular o valor em tempo real para edição ou novo lançamento
                calculateAndSetDiariaValue(isEditContext);
            }
            
            async function handleSalvarDiaria() {
                const colaboradorId = diariaColaboradorSelect.value;
                const dataDiaria = diariaDataInput.value;
                
                if (!colaboradorId || !dataDiaria) { alert('Por favor, selecione o colaborador e a data.'); return; }

                const colaborador = colaboradoresCache.find(c => c.id == colaboradorId);
                if (!colaborador) { alert('Colaborador não encontrado. Recarregue a página.'); return; }

                const { valorCalculado, horasTrabalhadas } = calculateAndSetDiariaValue(false); // Obtém o valor e horas da função de cálculo
                const dobrou = diariaDobrouCheckbox.checked;
                let horaEntrada = diariaHoraEntradaInput.value;
                let horaSaida = diariaHoraSaidaInput.value;

                // Validação específica para "Fixo com Dobra"
                const regra = regrasPagamentoCache.find(r => r.funcao === colaborador.funcao && r.tipo_calculo === 'Fixo com Dobra');
                if (regra) {
                    if (!dobrou && (!horaEntrada || !horaSaida)) {
                        alert('Para esta função, preencha o horário de entrada e saída, ou marque que dobrou o turno.'); 
                        return;
                    }
                    if (dobrou) {
                        horaEntrada = null;
                        horaSaida = null;
                    }
                }
                
                const lancamento = {
                    colaborador_id: colaboradorId, 
                    data_diaria: dataDiaria, 
                    valor_pago: valorCalculado, 
                    dobrou: dobrou, 
                    horas_trabalhadas: horasTrabalhadas,
                    horario_entrada: horaEntrada,
                    horario_saida: horaSaida,
                    funcao_colaborador: colaborador.funcao, 
                    setor_colaborador: colaborador.setor,
                    user_id: currentUser.id 
                };
                
                const { error } = await _supabase.from('diarias_lancadas').insert([lancamento]);
                if (error) { 
                    alert(`Erro ao lançar diária: ${error.message}`); 
                    console.error("Erro no lançamento da diária:", error.message || error.details || error);
                } else {
                    alert(`Diária de R$ ${valorCalculado.toFixed(2).replace('.', ',')} para ${colaborador.nome_completo} lançada com sucesso!`);
                    showScreen('dashboard');
                }
            }

            // --- RELATÓRIOS: PROCESSAMENTO, VISUALIZAÇÃO EM TELA, PDF E XLSX ---

            // Nova função para exibir a tela de relatórios
            function showRelatoriosScreen() {
                relatorioDataInicioInput.value = '';
                relatorioDataFimInput.value = '';
                resumoPagamentosDiv.style.display = 'none';
                resumoGastosDiv.style.display = 'none';
                showScreen('relatorios');
            }

            // Nova função para processar os dados do relatório de forma reutilizável
            async function processarDadosRelatorio(dataInicio, dataFim) {
                resumoPagamentosDiv.style.display = 'none';
                resumoGastosDiv.style.display = 'none';

                const { data: diarias, error: diariasError } = await _supabase
                    .from('diarias_lancadas')
                    .select(`
                        valor_pago,
                        funcao_colaborador, 
                        setor_colaborador, 
                        colaboradores(nome_completo, chave_pix, setor) 
                    `)
                    .gte('data_diaria', dataInicio)
                    .lte('data_diaria', dataFim);
                    
                if (diariasError) {
                    console.error("Erro ao buscar diárias para o relatório:", diariasError);
                    alert("Erro ao buscar dados para relatório. Tente novamente.");
                    return null;
                }

                if (diarias.length === 0) {
                    alert('Nenhuma diária encontrada para o período selecionado.');
                    return null;
                }

                const pagamentosPorColaborador = {};
                const gastosPorSetor = {};
                let totalGeral = 0;

                diarias.forEach(diaria => {
                    const nomeColaborador = diaria.colaboradores?.nome_completo || 'Colaborador Desconhecido';
                    const chavePix = diaria.colaboradores?.chave_pix || 'N/A';
                    const setor = diaria.setor_colaborador || diaria.colaboradores?.setor || 'Outros'; 
                    const valorDiaria = parseFloat(diaria.valor_pago);

                    if (isNaN(valorDiaria)) {
                        console.warn(`Diária com valor inválido ignorada:`, diaria);
                        return;
                    }

                    if (!pagamentosPorColaborador[nomeColaborador]) {
                        pagamentosPorColaborador[nomeColaborador] = {
                            pix: chavePix,
                            total: 0
                        };
                    }
                    pagamentosPorColaborador[nomeColaborador].total += valorDiaria;

                    if (!gastosPorSetor[setor]) {
                        gastosPorSetor[setor] = 0;
                    }
                    gastosPorSetor[setor] += valorDiaria;

                    totalGeral += valorDiaria;
                });

                // CORRIGIDO: Typo de pagamentosPorColador para pagamentosPorColaborador
                const tabelaPagamentosData = Object.keys(pagamentosPorColaborador).map(nome => {
                    return {
                        nome: nome,
                        pix: pagamentosPorColaborador[nome].pix, // Correção aqui
                        total: pagamentosPorColaborador[nome].total // Correção aqui
                    };
                }).sort((a, b) => a.nome.localeCompare(b.nome));

                const tabelaGastosSetorData = Object.keys(gastosPorSetor).map(setor => {
                    return {
                        setor: setor,
                        total: gastosPorSetor[setor]
                    };
                }).sort((a, b) => a.setor.localeCompare(b.setor));
                
                return {
                    pagamentos: tabelaPagamentosData,
                    gastos: tabelaGastosSetorData,
                    totalGeral: totalGeral,
                    periodo: { inicio: dataInicio, fim: dataFim }
                };
            }

            // Função para exibir o resumo na tela
            function exibirResumoNaTela(dadosProcessados) {
                const { pagamentos, gastos, totalGeral, periodo } = dadosProcessados;

                // Limpa e exibe a seção de pagamentos
                resumoPagamentosBody.innerHTML = '';
                pagamentos.forEach(item => {
                    const row = resumoPagamentosBody.insertRow();
                    row.innerHTML = `
                        <td class="text-left">${item.nome}</td>
                        <td class="text-left">${item.pix}</td>
                        <td class="text-right">R$ ${item.total.toFixed(2).replace('.', ',')}</td>
                    `;
                });
                resumoPagamentosTotal.textContent = `R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
                resumoPagamentosDiv.style.display = 'block';

                // Limpa e exibe a seção de gastos
                resumoGastosBody.innerHTML = '';
                gastos.forEach(item => {
                    const row = resumoGastosBody.insertRow();
                    row.innerHTML = `
                        <td class="text-left">${item.setor}</td>
                        <td class="text-right">R$ ${item.total.toFixed(2).replace('.', ',')}</td>
                    `;
                });
                resumoGastosDiv.style.display = 'block';
            }

            // Função para gerar PDF (melhorada com a função de processamento)
            async function gerarRelatorioPdf() {
                const dataInicio = relatorioDataInicioInput.value;
                const dataFim = relatorioDataFimInput.value;

                if (!dataInicio || !dataFim) {
                    alert('Por favor, selecione as datas de início e fim para o relatório.');
                    return;
                }
                
                const dadosProcessados = await processarDadosRelatorio(dataInicio, dataFim);
                if (!dadosProcessados) return; // Se não houver dados ou erro, sai

                const { pagamentos, gastos, totalGeral, periodo } = dadosProcessados;

                // Prepara os dados para autoTable
                const tabelaPagamentosPDF = pagamentos.map(p => [p.nome, p.pix, `R$ ${p.total.toFixed(2).replace('.', ',')}`]);
                const tabelaGastosPDF = gastos.map(g => [g.setor, `R$ ${g.total.toFixed(2).replace('.', ',')}`]);

                // --- Geração do PDF ---
                const doc = new jsPDF();
                const defaultMargin = 15; 
                const usableWidth = doc.internal.pageSize.getWidth() - (defaultMargin * 2); 
                
                const sectionTitleX = defaultMargin; 

                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.setTextColor(52, 58, 64); 
                doc.text("Relatório de Diárias", doc.internal.pageSize.getWidth() / 2, 25, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(12);
                doc.setTextColor(108, 117, 125); 
                const startDateFormatted = new Date(periodo.inicio + 'T00:00:00').toLocaleDateString('pt-BR');
                const endDateFormatted = new Date(periodo.fim + 'T00:00:00').toLocaleDateString('pt-BR');
                doc.text(`Período: ${startDateFormatted} a ${endDateFormatted}`, doc.internal.pageSize.getWidth() / 2, 35, { align: "center" });
                
                const now = new Date();
                const options = {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false, 
                    timeZone: 'America/Fortaleza' 
                };
                const generatedDateTime = now.toLocaleString('pt-BR', options);
                doc.text(`Gerado em: ${generatedDateTime}`, doc.internal.pageSize.getWidth() / 2, 42, { align: "center" });

                let yPos = 60; 

                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.setTextColor(52, 58, 64);
                doc.text("Pagamentos por Colaborador", sectionTitleX, yPos); 
                yPos += 10;
                doc.autoTable({
                    startY: yPos,
                    head: [['Nome Completo', 'Chave PIX', 'Valor Total']],
                    body: tabelaPagamentosPDF,
                    theme: 'striped',
                    styles: { 
                        fontSize: 10, 
                        cellPadding: 3, 
                        overflow: 'linebreak',
                        font: "helvetica", 
                        textColor: [52, 58, 64],
                    },
                    headStyles: { 
                        fillColor: [63, 106, 216], 
                        textColor: 255, 
                        fontStyle: 'bold',
                        fontSize: 11,
                    },
                    bodyStyles: { textColor: [33, 37, 41] },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    margin: { horizontal: defaultMargin }, 
                    // Ajuste de largura de colunas para PDF
                    columnStyles: {
                        0: { halign: 'left', cellWidth: usableWidth * 0.45 }, // Nome Completo (45%)
                        1: { halign: 'left', cellWidth: usableWidth * 0.30 }, // Chave PIX (30%)
                        2: { halign: 'right', cellWidth: usableWidth * 0.25 } // Valor Total (25%)
                    },
                    didParseCell: function(data) {
                        if (data.section === 'head' && data.column.index === 0) {
                            data.cell.styles.halign = 'left';
                        }
                    },
                    didDrawPage: function (data) {
                        let str = "Página " + doc.internal.getNumberOfPages();
                        doc.setFontSize(10);
                        doc.setTextColor(108, 117, 125);
                        doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                    }
                });

                yPos = doc.autoTable.previous.finalY + 20; 

                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.setTextColor(52, 58, 64);
                doc.text("Gastos por Setor", sectionTitleX, yPos); 
                yPos += 10;
                doc.autoTable({
                    startY: yPos,
                    head: [['Setor', 'Valor Total']],
                    body: tabelaGastosPDF,
                    theme: 'striped',
                    styles: { 
                        fontSize: 10, 
                        cellPadding: 3, 
                        overflow: 'linebreak',
                        font: "helvetica",
                        textColor: [52, 58, 64],
                    },
                    headStyles: { 
                        fillColor: [40, 167, 69], 
                        textColor: 255, 
                        fontStyle: 'bold',
                        fontSize: 11,
                    },
                    bodyStyles: { textColor: [33, 37, 41] },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    margin: { horizontal: defaultMargin }, 
                    // Ajuste de largura de colunas para PDF
                    columnStyles: {
                        0: { halign: 'left', cellWidth: usableWidth * 0.70 }, // Setor (70%)
                        1: { halign: 'right', cellWidth: usableWidth * 0.30 } // Valor Total (30%)
                    },
                    foot: [['TOTAL GERAL', `R$ ${totalGeral.toFixed(2).replace('.', ',')}`]], 
                    footStyles: {
                        fillColor: [52, 58, 64], 
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 11,
                        cellPadding: 4 
                    },
                    didParseCell: function(data) {
                        if (data.section === 'head' && data.column.index === 0) {
                            data.cell.styles.halign = 'left';
                        }
                        // CORRIGIDO: Alinha "TOTAL GERAL" à ESQUERDA na primeira coluna do rodapé
                        if (data.section === 'foot') {
                            if (data.column.index === 0) { 
                                data.cell.styles.halign = 'left'; 
                            } else if (data.column.index === 1) { 
                                data.cell.styles.halign = 'right'; 
                            }
                        }
                    },
                    didDrawPage: function (data) {
                        let str = "Página " + doc.internal.getNumberOfPages();
                        doc.setFontSize(10);
                        doc.setTextColor(108, 117, 125);
                        doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                    }
                });

                const filename = `Relatorio_Diarias_${periodo.inicio}_a_${periodo.fim}.pdf`;
                doc.save(filename);
            }

            // Função para gerar XLSX
            async function gerarRelatorioXlsx() {
                const dataInicio = relatorioDataInicioInput.value;
                const dataFim = relatorioDataFimInput.value;

                if (!dataInicio || !dataFim) {
                    alert('Por favor, selecione as datas de início e fim para o relatório.');
                    return;
                }

                console.log("Gerando relatório XLSX para o período:", dataInicio, "a", dataFim);

                const dadosProcessados = await processarDadosRelatorio(dataInicio, dataFim);
                if (!dadosProcessados) {
                    console.log("Nenhum dado processado para o relatório XLSX. Abortando geração.");
                    return;
                }

                console.log("Dados processados para XLSX:", dadosProcessados);

                const { pagamentos, gastos, totalGeral, periodo } = dadosProcessados;

                // Dados para a planilha
                const ws_data = [];

                // Título
                ws_data.push(["Relatório de Diárias"]);
                ws_data.push([`Período: ${new Date(periodo.inicio).toLocaleDateString('pt-BR')}' a '${new Date(periodo.fim).toLocaleDateString('pt-BR')}`]);
                ws_data.push([`Gerado em: ${new Date().toLocaleString('pt-BR', { timeZone: 'America/Fortaleza' })}`]);
                ws_data.push([]); // Linha em branco
                
                // Tabela de Pagamentos por Colaborador
                ws_data.push(["Pagamentos por Colaborador"]);
                ws_data.push(["Nome Completo", "Chave PIX", "Valor Total"]);
                pagamentos.forEach(p => {
                    ws_data.push([p.nome, p.pix, p.total]);
                });
                ws_data.push([]); // Linha em branco

                // Tabela de Gastos por Setor
                ws_data.push(["Gastos por Setor"]);
                ws_data.push(["Setor", "Valor Total"]);
                gastos.forEach(g => {
                    ws_data.push([g.setor, g.total]);
                });
                ws_data.push([]); // Linha em branco

                // Total Geral
                ws_data.push(["TOTAL GERAL", totalGeral]);

                console.log("Dados finais para a planilha XLSX:", ws_data);

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Relatório Diárias");
                
                const filename = `Relatorio_Diarias_${periodo.inicio}_a_${periodo.fim}.xlsx`;
                console.log("Tentando gerar arquivo XLSX:", filename);
                XLSX.writeFile(wb, filename);

                alert('Relatório XLSX gerado com sucesso!');
                console.log("Arquivo XLSX gerado com sucesso (XLSX.writeFile chamado).");
            }


            // --- LÓGICA DE CRIAÇÃO DE LOGIN ---
            function generateRandomNumericPassword(length = 6) {
                let password = '';
                for (let i = 0; i < length; i++) {
                    password += Math.floor(Math.random() * 10).toString();
                }
                return password;
            }

            async function handleCreateUser() {
                createUserErrorMessage.style.display = 'none';
                const email = createUserEmailInput.value.trim();
                const generatedPassword = generateRandomNumericPassword(); 
                
                generatedPasswordDisplay.value = generatedPassword; 

                if (!email) {
                    createUserErrorMessage.textContent = 'Por favor, preencha o email.';
                    createUserErrorMessage.style.display = 'block';
                    return;
                }

                if (currentUser.id !== ADMIN_USER_ID) {
                    createUserErrorMessage.textContent = 'Você não tem permissão para criar novos usuários. Entre em contato com o administrador.';
                    createUserErrorMessage.style.display = 'block';
                    return;
                }

                try {
                    const { data, error } = await _supabase.auth.signUp({
                        email: email,
                        password: generatedPassword, 
                    });

                    if (error) {
                        createUserErrorMessage.textContent = `Erro ao criar usuário: ${error.message}`;
                        createUserErrorMessage.style.display = 'block';
                    } else if (data.user) {
                        alert(`Usuário ${data.user.email} criado com sucesso! Senha: ${generatedPassword}. Um e-mail de confirmação pode ter sido enviado, dependendo da configuração do Supabase Auth.`);
                        createUserEmailInput.value = '';
                    }
                } catch (error) {
                    console.error("Erro inesperado na criação de usuário:", error);
                    createUserErrorMessage.textContent = `Erro inesperado: ${error.message}`;
                    createUserErrorMessage.style.display = 'block';
                }
            }

            // --- LÓGICA DE LISTAR LOGINS ---
            async function showListarLoginsScreen() {
                usersTableBody.innerHTML = '<tr><td colspan="1" style="text-align: center; padding: 20px;">Carregando usuários...</td></tr>';
                listarLoginsMessage.style.display = 'none';

                if (currentUser.id !== ADMIN_USER_ID) {
                    listarLoginsMessage.textContent = 'Você não tem permissão para visualizar esta tela.';
                    listarLoginsMessage.style.display = 'block';
                    usersTableBody.innerHTML = '';
                    showScreen('listarLogins'); 
                    return;
                }

                try {
                    const { data: allUsers, error: allUsersError } = await _supabase
                        .from('perfis') 
                        .select('id, email, nome_completo'); 

                    if (allUsersError) {
                        console.error("Erro ao buscar usuários (tabela perfis):", allUsersError.message || allUsersError.details || allUsersError); 
                        listarLoginsMessage.textContent = `Erro ao carregar usuários: ${allUsersError.message || 'Detalhes no console.'}.`;
                        listarLoginsMessage.style.display = 'block';
                        usersTableBody.innerHTML = '<tr><td colspan="1" style="text-align: center; padding: 20px;">Erro ao carregar usuários.</td></tr>';
                        return;
                    }
                    
                    usersTableBody.innerHTML = '';
                    if (allUsers.length === 0) {
                        usersTableBody.innerHTML = '<tr><td colspan="1" style="text-align: center; padding: 20px;">Nenhum usuário encontrado.</td></tr>';
                    } else {
                        allUsers.forEach(user => {
                            const row = usersTableBody.insertRow();
                            row.innerHTML = `
                                <td>${user.email || 'N/A'}</td>
                            `;
                        });
                    }
                } catch (error) {
                    console.error("Erro inesperado ao listar usuários:", error);
                    listarLoginsMessage.textContent = `Erro inesperado: ${error.message}.`;
                    listarLoginsMessage.style.display = 'block';
                    usersTableBody.innerHTML = '<tr><td colspan="1" style="text-align: center; padding: 20px;">Erro ao carregar usuários.</td></tr>';
                }
                showScreen('listarLogins');
            }

            // --- LÓGICA DE ALTERAR SENHA ---
            async function handleChangePassword() {
                changePasswordErrorMessage.style.display = 'none';
                const currentPassword = currentPasswordInput.value.trim();
                const newPassword = newPasswordInput.value.trim();
                const confirmNewPassword = confirmNewPasswordInput.value.trim();

                if (!currentPassword || !newPassword || !confirmNewPassword) {
                    changePasswordErrorMessage.textContent = 'Por favor, preencha todos os campos.';
                    changePasswordErrorMessage.style.display = 'block';
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    changePasswordErrorMessage.textContent = 'A nova senha e a confirmação não coincidem.';
                    changePasswordErrorMessage.style.display = 'block';
                    return;
                }
                if (newPassword.length < 6) {
                    changePasswordErrorMessage.textContent = 'A nova senha deve ter pelo menos 6 caracteres.';
                    changePasswordErrorMessage.style.display = 'block';
                    return;
                }

                try {
                    const { error: reauthError } = await _supabase.auth.signInWithPassword({
                        email: currentUser.email,
                        password: currentPassword
                    });

                    if (reauthError) {
                        if (reauthError.message.includes('Invalid login credentials') || reauthError.message.includes('AuthApiError: Invalid login credentials')) {
                             changePasswordErrorMessage.textContent = 'Senha atual incorreta.';
                        } else {
                            changePasswordErrorMessage.textContent = `Erro de reautenticação: ${reauthError.message}`;
                        }
                        changePasswordErrorMessage.style.display = 'block';
                        return;
                    }

                    const { error: updateError } = await _supabase.auth.updateUser({
                        password: newPassword
                    });

                    if (updateError) {
                        changePasswordErrorMessage.textContent = `Erro ao alterar senha: ${updateError.message}`;
                        changePasswordErrorMessage.style.display = 'block';
                    } else {
                        alert('Senha alterada com sucesso! Você será desconectado para logar com a nova senha.');
                        await _supabase.auth.signOut(); 
                        showScreen('login');
                        currentPasswordInput.value = '';
                        newPasswordInput.value = '';
                        confirmNewPasswordInput.value = '';
                    }
                } catch (error) {
                    console.error("Erro inesperado na alteração de senha:", error);
                    changePasswordErrorMessage.textContent = `Erro inesperado: ${error.message}`;
                    changePasswordErrorMessage.style.display = 'block';
                }
            }


            // --- NOVAS FUNCIONALIDADES: GERENCIAR DIÁRIAS E HISTÓRICO ---
            
            // --- Gerenciar Diárias (screenGerenciarDiarias) ---
            async function showGerenciarDiariasScreen() {
                // CORRIGIDO: Certifica-se de que o modal esteja fechado ao carregar a tela
                editDiariaModal.classList.remove('active'); 

                gerenciarDiariasTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Carregando diárias...</td></tr>';
                showScreen('gerenciarDiarias');

                const { data: diariasData, error: diariasError } = await _supabase
                    .from('diarias_lancadas')
                    .select(`
                        id,
                        data_diaria,
                        valor_pago,
                        dobrou,
                        horas_trabalhadas,
                        horario_entrada,
                        horario_saida,
                        funcao_colaborador,
                        setor_colaborador,
                        colaborador_id,
                        user_id
                    `)
                    .order('data_diaria', { ascending: false });

                if (diariasError) {
                    console.error("Erro ao buscar diárias para gerenciamento:", diariasError.message || diariasError.details || diariasError); 
                    gerenciarDiariasTableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">Erro ao carregar diárias: ${diariasError.message || 'Verifique o console para detalhes.'}</td></tr>`;
                    return;
                }
                diariasCache = diariasData; 

                gerenciarDiariasTableBody.innerHTML = '';
                if (diariasCache.length === 0) {
                    gerenciarDiariasTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Nenhuma diária lançada.</td></tr>';
                    return;
                }

                // Carregar nomes de colaboradores e perfis para exibição
                const { data: colabsData, error: colabsError } = await _supabase.from('colaboradores').select('id, nome_completo');
                if (colabsError) { console.error("Erro ao buscar nomes de colaboradores:", colabsError); return; }
                const colabsMap = new Map(colabsData.map(c => [c.id, c.nome_completo]));

                const { data: perfisData, error: perfisError } = await _supabase.from('perfis').select('id, email, nome_completo');
                if (perfisError) { console.error("Erro ao buscar nomes/emails de perfis:", perfisError); return; }
                const perfisMap = new Map();
                perfisData.forEach(p => {
                    perfisMap.set(p.id, p.nome_completo || p.email);
                });


                diariasCache.forEach(diaria => {
                    const row = gerenciarDiariasTableBody.insertRow();
                    const colaboradorNome = colabsMap.get(diaria.colaborador_id) || 'Desconhecido'; 
                    // CORRIGIDO: Fallback para user_id (truncado) se nome/email não for encontrado no perfil
                    const lancadoPor = perfisMap.get(diaria.user_id) || (diaria.user_id ? `ID: ${diaria.user_id.substring(0, 8)}...` : 'N/A');
                    if (!perfisMap.has(diaria.user_id) && diaria.user_id) {
                         console.warn(`User ID ${diaria.user_id} em diárias_lancadas não encontrado na tabela perfis.`);
                    }
                    
                    row.innerHTML = `
                        <td>${colaboradorNome}</td> <td>${new Date(diaria.data_diaria + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                        <td>${diaria.funcao_colaborador}</td>
                        <td>${diaria.setor_colaborador}</td>
                        <td>R$ ${diaria.valor_pago.toFixed(2).replace('.', ',')}</td>
                        <td>${lancadoPor}</td>
                        <td>
                            <button class="btn-secondary btn-sm" data-action="edit-diaria" data-id="${diaria.id}" style="padding: 5px 10px; font-size: 0.8rem;">Editar</button>
                            <button class="btn-danger btn-sm" data-action="delete-diaria" data-id="${diaria.id}" style="padding: 5px 10px; font-size: 0.8rem;">Excluir</button>
                        </td>
                    `;
                });

                gerenciarDiariasTableBody.querySelectorAll('button[data-action="edit-diaria"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        handleEditDiaria(id);
                    });
                });
                gerenciarDiariasTableBody.querySelectorAll('button[data-action="delete-diaria"]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        handleDeleteDiaria(id);
                    });
                });
            }

            // --- Gerenciar Diárias: Lógica de Edição ---
            async function handleEditDiaria(diariaId) {
                const diaria = diariasCache.find(d => d.id === diariaId);
                if (!diaria) {
                    alert('Diária não encontrada para edição.');
                    return;
                }

                editDiariaIdInput.value = diaria.id;
                // Busca o nome do colaborador a partir do cache de colaboradores
                const colaboradorEdit = colaboradoresCache.find(c => c.id === diaria.colaborador_id);
                editDiariaColaboradorNomeInput.value = colaboradorEdit?.nome_completo || 'Desconhecido';
                editDiariaColaboradorNomeInput.dataset.colabId = diaria.colaborador_id; 

                editDiariaDataInput.value = diaria.data_diaria;
                editDiariaFuncaoSelect.value = diaria.funcao_colaborador;
                editDiariaSetorSelect.value = diaria.setor_colaborador;
                editDiariaDobrouCheckbox.checked = diaria.dobrou;
                editDiariaHoraEntradaInput.value = diaria.horario_entrada || '';
                editDiariaHoraSaidaInput.value = diaria.horario_saida || '';
                
                // Força o cálculo e atualização do campo de valor logo ao abrir o modal
                calculateAndSetDiariaValue(true);

                // Ajustar visibilidade dos campos de horas na edição
                toggleDiariaFields(true); // true para contexto de edição

                editDiariaModal.classList.add('active'); // CORRIGIDO: Adiciona a classe 'active' para exibir
            }

            // Lógica para calcular e atualizar o valor no modal de edição
            editDiariaFuncaoSelect.addEventListener('change', () => calculateAndSetDiariaValue(true));
            editDiariaDobrouCheckbox.addEventListener('change', () => toggleDiariaFields(true)); 
            editDiariaHoraEntradaInput.addEventListener('change', () => calculateAndSetDiariaValue(true));
            editDiariaHoraSaidaInput.addEventListener('change', () => calculateAndSetDiariaValue(true));


            async function handleSaveEditDiaria() {
                const diariaId = editDiariaIdInput.value;
                const dataDiaria = editDiariaDataInput.value;
                const funcaoColaborador = editDiariaFuncaoSelect.value;
                const setorColaborador = editDiariaSetorSelect.value;
                const dobrou = editDiariaDobrouCheckbox.checked;
                const horarioEntrada = editDiariaHoraEntradaInput.value;
                const horarioSaida = editDiariaHoraSaidaInput.value;

                // Recalcular o valor e horas com base nos novos dados
                const { valorCalculado, horasTrabalhadas } = calculateAndSetDiariaValue(true); 
                
                // Validação específica para "Fixo com Dobra"
                const regra = regrasPagamentoCache.find(r => r.funcao === funcaoColaborador && r.tipo_calculo === 'Fixo com Dobra');
                if (regra) {
                    if (!dobrou && (!horarioEntrada || !horarioSaida)) {
                        alert('Para esta função, preencha o horário de entrada e saída, ou marque que dobrou o turno.'); 
                        return;
                    }
                }
                
                const updatedFields = {
                    data_diaria: dataDiaria,
                    valor_pago: valorCalculado,
                    dobrou: dobrou,
                    horas_trabalhadas: horasTrabalhadas,
                    horario_entrada: horarioEntrada || null,
                    horario_saida: horarioSaida || null,
                    funcao_colaborador: funcaoColaborador,
                    setor_colaborador: setorColaborador
                };

                const { error } = await _supabase
                    .from('diarias_lancadas')
                    .update(updatedFields)
                    .eq('id', diariaId);

                if (error) {
                    alert(`Erro ao atualizar diária: ${error.message}`);
                    console.error("Erro na atualização da diária:", error);
                } else {
                    alert('Diária atualizada com sucesso!');
                    editDiariaModal.classList.remove('active'); // CORRIGIDO: Remove a classe 'active' para fechar
                    showGerenciarDiariasScreen(); 
                }
            }

            // --- Gerenciar Diárias: Lógica de Exclusão ---
            async function handleDeleteDiaria(diariaId) {
                if (!confirm('Tem certeza que deseja excluir esta diária? Esta ação não pode ser desfeita.')) {
                    return;
                }

                const { error } = await _supabase
                    .from('diarias_lancadas')
                    .delete()
                    .eq('id', diariaId);

                if (error) {
                    alert(`Erro ao excluir diária: ${error.message}`);
                    console.error("Erro na exclusão da diária:", error);
                } else {
                    alert('Diária excluída com sucesso!');
                    showGerenciarDiariasScreen(); 
                }
            }

            // --- Histórico (screenHistorico) ---
            async function showHistoricoScreen() {
                // Ajustado colspan para 5, com a coluna Diária ID restaurada
                historicoTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Carregando histórico...</td></tr>';
                showScreen('historico');

                const { data, error } = await _supabase
                    .from('diaria_historico')
                    .select(`
                        id,
                        diaria_id,
                        user_id,
                        user_email,
                        action,
                        old_data,
                        new_data,
                        timestamp
                    `)
                    .order('timestamp', { ascending: false });

                if (error) {
                    console.error("Erro ao buscar histórico:", error.message || error.details || error); 
                    historicoTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">Erro ao carregar histórico: ${error.message || 'Verifique o console para detalhes.'}</td></tr>`;
                    return;
                }

                historicoTableBody.innerHTML = '';
                if (data.length === 0) {
                    historicoTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Nenhum registro no histórico.</td></tr>';
                    return;
                }

                data.forEach(record => {
                    const row = historicoTableBody.insertRow();
                    const recordDate = new Date(record.timestamp).toLocaleString('pt-BR');
                    const actionDetails = formatHistoryDetails(record.action, record.old_data, record.new_data);
                    
                    row.innerHTML = `
                        <td>${recordDate}</td>
                        <td>${record.action.toUpperCase()}</td>
                        <td>${record.diaria_id ? record.diaria_id.substring(0, 8) + '...' : 'N/A'}</td> <td>${record.user_email || 'Desconhecido'}</td>
                        <td>${actionDetails}</td>
                    `;
                });
            }

            // Função auxiliar para formatar detalhes do histórico
            function formatHistoryDetails(action, oldData, newData) {
                const getColabNameFromData = (dataObj) => {
                    if (dataObj && dataObj.colaborador_id) { 
                        const colab = colaboradoresCache.find(c => c.id === dataObj.colaborador_id);
                        if (colab) return colab.nome_completo;
                    }
                    return dataObj?.funcao_colaborador || 'colaborador';
                };

                switch (action) {
                    case 'created':
                        return `Diária de ${getColabNameFromData(newData)} (R$ ${newData?.valor_pago?.toFixed(2).replace('.', ',')}) criada.`;
                    case 'updated':
                        let details = `Diária de ${getColabNameFromData(oldData)} alterada. `;
                        if (oldData?.valor_pago !== newData?.valor_pago) {
                            details += `Valor: R$ ${oldData?.valor_pago?.toFixed(2).replace('.', ',')} -> R$ ${newData?.valor_pago?.toFixed(2).replace('.', ',')}. `;
                        }
                        if (oldData?.funcao_colaborador !== newData?.funcao_colaborador) {
                            details += `Função: ${oldData?.funcao_colaborador} -> ${newData?.funcao_colaborador}. `;
                        }
                        if (oldData?.data_diaria !== newData?.data_diaria) {
                            details += `Data: ${new Date(oldData?.data_diaria + 'T00:00:00').toLocaleDateString('pt-BR')} -> ${new Date(newData?.data_diaria + 'T00:00:00').toLocaleDateString('pt-BR')}. `;
                        }
                        return details.trim();
                    case 'deleted':
                        return `Diária de ${getColabNameFromData(oldData)} (R$ ${oldData?.valor_pago?.toFixed(2).replace('.', ',')}) excluída.`;
                    default:
                        return JSON.stringify(newData || oldData || {});
                }
            }

            // --- Gerenciar Regras de Pagamento ---
            async function showGerenciarRegrasScreen() {
                regrasPagamentoList.innerHTML = '<p style="text-align: center; padding: 20px;">Carregando regras de pagamento...</p>';
                showScreen('gerenciarRegras');
                await fetchRegrasPagamento(); // Garante que as regras estão atualizadas

                regrasPagamentoList.innerHTML = '';
                if (regrasPagamentoCache.length === 0) {
                    regrasPagamentoList.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhuma regra de pagamento cadastrada. Por favor, adicione uma manualmente no banco de dados se necessário.</p>';
                    return;
                }

                regrasPagamentoCache.forEach(regra => {
                    const regraDiv = document.createElement('div');
                    regraDiv.classList.add('regra-item');
                    regraDiv.dataset.id = regra.id;

                    const isFixed = regra.tipo_calculo === 'Fixo';
                    const isHourlyOrDoubled = regra.tipo_calculo === 'Fixo com Dobra';

                    regraDiv.innerHTML = `
                        <strong>${regra.funcao}</strong>
                        <div class="form-group">
                            <label for="tipoCalculo-${regra.id}">Tipo de Cálculo:</label>
                            <select id="tipoCalculo-${regra.id}" data-field="tipo_calculo" data-id="${regra.id}">
                                <option value="Fixo" ${isFixed ? 'selected' : ''}>Fixo</option>
                                <option value="Fixo com Dobra" ${isHourlyOrDoubled ? 'selected' : ''}>Fixo com Dobra</option>
                            </select>
                        </div>
                        <div class="regra-fields">
                            <div class="form-group" id="valorBaseGroup-${regra.id}">
                                <label for="valorBase-${regra.id}">Valor Base (R$):</label>
                                <input type="number" step="0.01" id="valorBase-${regra.id}" value="${regra.valor_base}" data-field="valor_base" data-id="${regra.id}">
                            </div>
                            <div class="form-group" id="horasBaseGroup-${regra.id}">
                                <label for="horasBase-${regra.id}">Horas Base:</label>
                                <input type="number" step="1" id="horasBase-${regra.id}" value="${regra.horas_base || ''}" data-field="horas_base" data-id="${regra.id}">
                            </div>
                            <div class="form-group" id="valorHoraExtraGroup-${regra.id}">
                                <label for="valorHoraExtra-${regra.id}">Valor Hora Extra (R$):</label>
                                <input type="number" step="0.01" id="valorHoraExtra-${regra.id}" value="${regra.valor_hora_extra || ''}" data-field="valor_hora_extra" data-id="${regra.id}">
                            </div>
                            <div class="form-group" id="valorDobraSemanaGroup-${regra.id}">
                                <label for="valorDobraSemana-${regra.id}">Valor Dobra (Semana - R$):</label>
                                <input type="number" step="0.01" id="valorDobraSemana-${regra.id}" value="${regra.valor_dobra_semana || ''}" data-field="valor_dobra_semana" data-id="${regra.id}">
                            </div>
                            <div class="form-group" id="valorDobraFDSGroup-${regra.id}">
                                <label for="valorDobraFDS-${regra.id}">Valor Dobra (FDS - R$):</label>
                                <input type="number" step="0.01" id="valorDobraFDS-${regra.id}" value="${regra.valor_dobra_fds || ''}" data-field="valor_dobra_fds" data-id="${regra.id}">
                            </div>
                        </div>
                        <div class="regra-buttons">
                            <button class="btn-primary btn-sm save-regra-btn" data-id="${regra.id}">Salvar</button>
                        </div>
                    `;
                    regrasPagamentoList.appendChild(regraDiv);
                    // Garante a visibilidade inicial correta dos campos para cada tipo de cálculo
                    toggleRegraFieldsVisibility(regra.id, regra.tipo_calculo);
                });

                regrasPagamentoList.querySelectorAll('.save-regra-btn').forEach(button => {
                    button.addEventListener('click', handleSaveRegra);
                });

                // Ações para mostrar/esconder campos com base no tipo de cálculo (para inputs manuais)
                regrasPagamentoList.querySelectorAll('[data-field="tipo_calculo"]').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const id = e.target.dataset.id;
                        const newType = e.target.value;
                        toggleRegraFieldsVisibility(id, newType);
                    });
                });
            }

            // Função para alternar visibilidade dos campos da regra
            function toggleRegraFieldsVisibility(id, type) {
                const isFixed = type === 'Fixo';
                const isHourlyOrDoubled = type === 'Fixo com Dobra';

                // Esconde todos os grupos primeiro
                const groupsToToggle = [
                    `valorBaseGroup-${id}`, `horasBaseGroup-${id}`, `valorHoraExtraGroup-${id}`,
                    `valorDobraSemanaGroup-${id}`, `valorDobraFDSGroup-${id}`
                ];
                groupsToToggle.forEach(groupId => {
                    const el = document.getElementById(groupId);
                    if (el) el.classList.add('hidden');
                });

                // Mostra os grupos relevantes
                if (isFixed || isHourlyOrDoubled) { 
                    const el = document.getElementById(`valorBaseGroup-${id}`);
                    if (el) el.classList.remove('hidden');
                }
                if (isHourlyOrDoubled) {
                    const horasBaseEl = document.getElementById(`horasBaseGroup-${id}`);
                    const valorHoraExtraEl = document.getElementById(`valorHoraExtraGroup-${id}`);
                    const valorDobraSemanaEl = document.getElementById(`valorDobraSemanaGroup-${id}`);
                    const valorDobraFDSEl = document.getElementById(`valorDobraFDSGroup-${id}`);
                    
                    if(horasBaseEl) horasBaseEl.classList.remove('hidden');
                    if(valorHoraExtraEl) valorHoraExtraEl.classList.remove('hidden');
                    if(valorDobraSemanaEl) valorDobraSemanaEl.classList.remove('hidden');
                    if(valorDobraFDSEl) valorDobraFDSEl.classList.remove('hidden');
                }

                // Limpa valores dos campos ocultos para evitar dados inconsistentes no banco
                const currentRegraDiv = document.querySelector(`.regra-item[data-id="${id}"]`);
                if (!isHourlyOrDoubled) { 
                    const horasBaseInput = currentRegraDiv.querySelector(`#horasBase-${id}`);
                    const valorHoraExtraInput = currentRegraDiv.querySelector(`#valorHoraExtra-${id}`);
                    const valorDobraSemanaInput = currentRegraDiv.querySelector(`#valorDobraSemana-${id}`);
                    const valorDobraFDSInput = currentRegraDiv.querySelector(`#valorDobraFDS-${id}`);
                    
                    if(horasBaseInput) horasBaseInput.value = '';
                    if(valorHoraExtraInput) valorHoraExtraInput.value = '';
                    if(valorDobraSemanaInput) valorDobraSemanaInput.value = '';
                    if(valorDobraFDSInput) valorDobraFDSInput.value = '';
                }
                if (!isFixed && !isHourlyOrDoubled) { 
                     const valorBaseInput = currentRegraDiv.querySelector(`#valorBase-${id}`);
                     if(valorBaseInput) valorBaseInput.value = '';
                }
            }


            async function handleSaveRegra(event) {
                const regraId = event.target.dataset.id;
                const regraDiv = document.querySelector(`.regra-item[data-id="${regraId}"]`);
                
                const updatedFields = {};
                regraDiv.querySelectorAll('input[data-field], select[data-field]').forEach(input => {
                    const field = input.dataset.field;
                    let value = input.value;

                    if (input.type === 'number') {
                        value = value === '' ? null : parseFloat(value); 
                    }
                    updatedFields[field] = value;
                });
                
                const { error } = await _supabase
                    .from('regras_pagamento')
                    .update(updatedFields)
                    .eq('id', regraId);

                if (error) {
                    alert(`Erro ao atualizar regra: ${error.message}`);
                    console.error("Erro na atualização da regra:", error);
                } else {
                    alert('Regra de pagamento atualizada com sucesso!');
                    showGerenciarRegrasScreen(); // Recarrega a lista de regras
                }
            }


            // --- FUNÇÕES DE MASCARAMENTO ---
            function formatCpf(value) {
                if (!value) return '';
                value = String(value).replace(/\D/g, ''); 
                if (value.length > 11) value = value.substring(0, 11);
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                return value;
            }

            function formatTelefone(value) {
                if (!value) return '';
                value = String(value).replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);
                if (value.length > 10) {
                    value = value.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3');
                } else if (value.length > 5) {
                    value = value.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, '($1) $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/^(\d\d)(\d{0,5})/, '($1) $2');
                }
                return value;
            }

            // Aplicar máscaras nos inputs de colaborador
            colabCpfInput.addEventListener('input', (e) => {
                e.target.value = formatCpf(e.target.value);
            });
            colabTelefoneInput.addEventListener('input', (e) => {
                e.target.value = formatTelefone(e.target.value);
            });

            // --- NOVO: Relatório de Colaboradores ---
            async function showRelatorioColaboradoresScreen() {
                relatorioColaboradoresTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Carregando colaboradores...</td></tr>';
                showScreen('relatorioColaboradores');
                
                const { data, error } = await _supabase.from('colaboradores').select('*').order('nome_completo');
                if (error) {
                    console.error("Erro ao buscar colaboradores para relatório:", error);
                    alert("Erro ao carregar colaboradores para relatório.");
                    relatorioColaboradoresTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Erro ao carregar colaboradores.</td></tr>';
                    return;
                }

                if (data.length === 0) {
                    relatorioColaboradoresTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Nenhum colaborador cadastrado.</td></tr>';
                    return;
                }

                relatorioColaboradoresTableBody.innerHTML = '';
                data.forEach(colab => {
                    const row = relatorioColaboradoresTableBody.insertRow();
                    row.innerHTML = `
                        <td>${colab.nome_completo}</td>
                        <td>${colab.funcao}</td>
                        <td>${colab.setor}</td>
                        <td>${colab.chave_pix || 'N/A'}</td>
                        <td>${formatCpf(colab.cpf) || 'N/A'}</td>
                        <td>${formatTelefone(colab.telefone) || 'N/A'}</td>
                        <td>${colab.endereco || 'N/A'}</td>
                        <td>${colab.data_nascimento ? new Date(colab.data_nascimento).toLocaleDateString('pt-BR') : 'N/A'}</td>
                        <td>${colab.nome_mae || 'N/A'}</td>
                    `;
                });
            }

            async function gerarRelatorioColaboradoresPdf() {
                const { data: colaboradoresData, error } = await _supabase.from('colaboradores').select('*').order('nome_completo');
                if (error) {
                    console.error("Erro ao buscar colaboradores para PDF:", error);
                    alert("Erro ao gerar PDF de colaboradores.");
                    return;
                }

                if (colaboradoresData.length === 0) {
                    alert('Nenhum colaborador para gerar relatório.');
                    return;
                }

                const doc = new jsPDF('landscape'); // 'landscape' para mais colunas
                const defaultMargin = 15;
                const usableWidth = doc.internal.pageSize.getWidth() - (defaultMargin * 2);

                doc.setFont("helvetica", "bold");
                doc.setFontSize(20);
                doc.setTextColor(52, 58, 64);
                doc.text("Relatório de Colaboradores Cadastrados", doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(108, 117, 125);
                const now = new Date();
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'America/Fortaleza' };
                const generatedDateTime = now.toLocaleString('pt-BR', options);
                doc.text(`Gerado em: ${generatedDateTime}`, doc.internal.pageSize.getWidth() / 2, 28, { align: "center" });

                doc.autoTable({
                    startY: 35,
                    head: [['Nome Completo', 'Função', 'Setor', 'PIX', 'CPF', 'Telefone', 'Endereço', 'Nasc.', 'Nome Mãe']],
                    body: colaboradoresData.map(colab => [
                        colab.nome_completo,
                        colab.funcao,
                        colab.setor,
                        colab.chave_pix || '',
                        formatCpf(colab.cpf) || '',
                        formatTelefone(colab.telefone) || '',
                        colab.endereco || '',
                        colab.data_nascimento ? new Date(colab.data_nascimento).toLocaleDateString('pt-BR') : '',
                        colab.nome_mae || ''
                    ]),
                    theme: 'striped',
                    styles: {
                        fontSize: 8, // Fonte menor para caber mais
                        cellPadding: 2,
                        overflow: 'linebreak',
                        font: "helvetica",
                        textColor: [52, 58, 64],
                    },
                    headStyles: {
                        fillColor: [63, 106, 216],
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 9,
                    },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    margin: { horizontal: defaultMargin },
                    columnStyles: {
                        0: { cellWidth: usableWidth * 0.18 }, // Nome
                        1: { cellWidth: usableWidth * 0.10 }, // Função
                        2: { cellWidth: usableWidth * 0.10 }, // Setor
                        3: { cellWidth: usableWidth * 0.12 }, // PIX
                        4: { cellWidth: usableWidth * 0.12 }, // CPF
                        5: { cellWidth: usableWidth * 0.12 }, // Telefone
                        6: { cellWidth: usableWidth * 0.16 }, // Endereço
                        7: { cellWidth: usableWidth * 0.05 }, // Nasc.
                        8: { cellWidth: usableWidth * 0.05 }  // Nome Mãe
                    },
                    didDrawPage: function (data) {
                        let str = "Página " + doc.internal.getNumberOfPages();
                        doc.setFontSize(10);
                        doc.setTextColor(108, 117, 125);
                        doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                    }
                });

                doc.save(`Relatorio_Colaboradores_${new Date().toLocaleDateString('pt-BR')}.pdf`);
                alert('Relatório de Colaboradores PDF gerado com sucesso!');
            }


            // --- INICIALIZAÇÃO E LISTENERS GERAIS ---
            async function initializeApp() {
                // Carregar regras de pagamento logo na inicialização
                await fetchRegrasPagamento();

                // Login
                loginButton.addEventListener('click', handleLogin);
                logoutButton.addEventListener('click', handleLogout);
                loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
                
                // Colaboradores
                btnGoToListarColaboradores.addEventListener('click', async () => {
                    await fetchAndRenderColaboradores();
                    showScreen('listarColaboradores');
                });
                btnGoToAdicionarColaborador.addEventListener('click', () => {
                    colabNomeInput.value = ''; 
                    colabFuncaoSelect.value = ''; 
                    colabSetorSelect.value = ''; 
                    colabPixInput.value = ''; 
                    colabCpfInput.value = ''; 
                    colabTelefoneInput.value = ''; 
                    colabEnderecoInput.value = '';
                    colabDataNascimentoInput.value = '';
                    colabNomeMaeInput.value = '';
                    editingColaboradorId = null; 
                    colaboradorFormTitle.textContent = 'Adicionar Novo Colaborador';
                    btnSalvarColaborador.textContent = 'Salvar Novo Colaborador';
                    btnSalvarColaborador.classList.remove('btn-primary'); 
                    btnSalvarColaborador.classList.add('btn-success');
                    showScreen('adicionarColaborador');
                });
                btnAdicionarColabVoltar.addEventListener('click', () => showScreen('listarColaboradores')); 
                btnListarColabVoltar.addEventListener('click', () => showScreen('dashboard')); 
                btnSalvarColaborador.addEventListener('click', handleSalvarColaborador);
                
                // Lançamento de Diárias
                btnGoToLancarDiaria.addEventListener('click', showLancarDiariasScreen);
                btnLancarDiariasVoltar.addEventListener('click', () => showScreen('dashboard')); 
                diariaColaboradorSelect.addEventListener('change', () => toggleDiariaFields(false));
                diariaDobrouCheckbox.addEventListener('change', () => toggleDiariaFields(false));
                diariaHoraEntradaInput.addEventListener('change', () => calculateAndSetDiariaValue(false)); 
                diariaHoraSaidaInput.addEventListener('change', () => calculateAndSetDiariaValue(false)); 
                btnSalvarDiaria.addEventListener('click', handleSalvarDiaria);
                
                // Relatórios
                btnGoToRelatorios.addEventListener('click', showRelatoriosScreen);
                btnRelatoriosVoltar.addEventListener('click', () => {
                    resumoPagamentosDiv.style.display = 'none';
                    resumoGastosDiv.style.display = 'none';
                    showScreen('dashboard');
                });
                btnVerResumo.addEventListener('click', async () => {
                    const dataInicio = relatorioDataInicioInput.value;
                    const dataFim = relatorioDataFimInput.value;
                    if (!dataInicio || !dataFim) {
                        alert('Por favor, selecione as datas de início e fim para o relatório.');
                        return;
                    }
                    const dados = await processarDadosRelatorio(dataInicio, dataFim);
                    if (dados) {
                        exibirResumoNaTela(dados);
                    } else {
                        resumoPagamentosDiv.style.display = 'none';
                        resumoGastosDiv.style.display = 'none';
                    }
                });
                btnGerarRelatorioPdf.addEventListener('click', gerarRelatorioPdf);
                btnGerarRelatorioXlsx.addEventListener('click', gerarRelatorioXlsx);

                // Criação de Login
                btnGoToCriarLogin.addEventListener('click', () => {
                    createUserEmailInput.value = '';
                    generatedPasswordDisplay.value = ''; 
                    createUserErrorMessage.style.display = 'none';
                    showScreen('criarLogin');
                });
                btnCriarLoginVoltar.addEventListener('click', () => showScreen('dashboard'));
                btnCreateUser.addEventListener('click', handleCreateUser);
                createUserEmailInput.addEventListener('keypress', (e) => { 
                    if (e.key === 'Enter') handleCreateUser(); 
                });
                
                // Listar Logins
                btnGoToListarLogins.addEventListener('click', showListarLoginsScreen);
                btnListarLoginsVoltar.addEventListener('click', () => showScreen('dashboard'));

                // Alterar Senha
                btnGoToAlterarSenha.addEventListener('click', () => {
                    currentPasswordInput.value = '';
                    newPasswordInput.value = '';
                    confirmNewPasswordInput.value = '';
                    changePasswordErrorMessage.style.display = 'none';
                    showScreen('alterarSenha');
                });
                btnAlterarSenhaVoltar.addEventListener('click', () => showScreen('dashboard'));
                btnChangePassword.addEventListener('click', handleChangePassword);
                confirmNewPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleChangePassword();
                });

                // Gerenciar Diárias
                btnGoToGerenciarDiarias.addEventListener('click', showGerenciarDiariasScreen);
                btnGerenciarDiariasVoltar.addEventListener('click', () => showScreen('dashboard'));
                closeEditModalButton.addEventListener('click', () => editDiariaModal.classList.remove('active'));
                cancelEditDiariaButton.addEventListener('click', () => editDiariaModal.classList.remove('active'));
                saveEditDiariaButton.addEventListener('click', handleSaveEditDiaria);
                window.addEventListener('click', (event) => {
                    if (event.target == editDiariaModal) {
                        editDiariaModal.classList.remove('active');
                    }
                });

                // Histórico
                btnGoToHistorico.addEventListener('click', showHistoricoScreen);
                btnHistoricoVoltar.addEventListener('click', () => showScreen('dashboard'));

                // Gerenciar Regras de Pagamento (NOVO)
                btnGoToGerenciarRegras.addEventListener('click', showGerenciarRegrasScreen);
                btnGerenciarRegrasVoltar.addEventListener('click', () => showScreen('dashboard'));

                // NOVO: Relatório de Colaboradores
                btnGoToRelatorioColaboradores.addEventListener('click', showRelatorioColaboradoresScreen);
                btnRelatorioColaboradoresVoltar.addEventListener('click', () => showScreen('dashboard'));
                btnGerarRelatorioColaboradoresPdf.addEventListener('click', gerarRelatorioColaboradoresPdf);
                
                // Inicialização da sessão
                const { data: { session } } = await _supabase.auth.getSession();
                if (session) { await setupDashboard(session.user); } 
                else { showScreen('login'); }
            }
            initializeApp();
        });
    </script>
</body>
</html>