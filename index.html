<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Di√°rias</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÑ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Vari√°veis de Design Global */
        :root {
            --color-primary: #3f6ad8; /* Azul principal mais moderno */
            --color-secondary: #6c757d; /* Cinza secund√°rio */
            --color-success: #28a745; /* Verde padr√£o */
            --color-danger: #dc3545; /* Vermelho padr√£o */
            
            --color-background-light: #f8f9fa; /* Fundo suave, quase branco */
            --color-background-medium: #e9ecef; /* Para cabe√ßalhos de tabela */
            --color-surface: #ffffff; /* Fundo de cards e elementos */
            
            --color-text-dark: #343a40; /* Texto principal escuro */
            --color-text-muted: #6c757d; /* Texto secund√°rio */
            --color-text-on-primary: #ffffff; /* Texto sobre o azul principal */
            
            --border-radius-soft: 0.5rem; /* Bordas arredondadas */
            --shadow-subtle: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.08); /* Sombra mais discreta */
            --shadow-medium: 0 0.3rem 0.8rem rgba(0, 0, 0, 0.12); /* Sombra ao hover */
            
            --spacing-unit: 1rem; /* Unidade base de espa√ßamento */
        }

        /* Base do Corpo */
        body {
            font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; /* Fonte mais moderna e limpa */
            margin: 0;
            padding: var(--spacing-unit);
            background-color: var(--color-background-light);
            color: var(--color-text-dark);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            line-height: 1.6;
            font-size: 16px; /* Tamanho base da fonte */
        }

        /* Cont√™iner Principal */
        .container {
            width: 100%;
            max-width: 1024px; /* Um pouco m√°s compacto para foco */
            margin-top: calc(var(--spacing-unit) * 2);
        }

        /* Gerenciamento de Telas */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeInView 0.5s ease-out; }
        @keyframes fadeInView { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Estilo dos Cards */
        .card {
            background-color: var(--color-surface);
            padding: calc(var(--spacing-unit) * 1.5);
            border-radius: var(--border-radius-soft);
            box-shadow: var(--shadow-subtle);
            border: 1px solid var(--color-background-medium); /* Borda sutil */
            margin-bottom: var(--spacing-unit);
        }

        /* T√≠tulos */
        h1, h2, h3 { 
            text-align: center; 
            margin-top: 0; 
            color: var(--color-primary); /* T√≠tulos em cor prim√°ria */
            line-height: 1.2; 
            font-weight: 600; /* M√°s peso */
        }
        h1 { font-size: 2.2rem; margin-bottom: var(--spacing-unit); }
        h2 { font-size: 1.8rem; text-align: left; margin-bottom: calc(var(--spacing-unit) * 1.2); }
        h3 { 
            text-align: left; /* Default para h3 internos */
            border-bottom: 1px solid var(--color-background-medium); 
            padding-bottom: calc(var(--spacing-unit) * 0.5); 
            margin-bottom: calc(var(--spacing-unit) * 1.25); 
            font-size: 1.3rem;
            color: var(--color-text-dark); /* Sub-t√≠tulos em texto escuro */
        }

        /* Bot√µes Base */
        button {
            border: none;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--border-radius-soft);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-subtle);
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            opacity: 0.95;
        }
        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-subtle);
        }

        .btn-primary { background-color: var(--color-primary); color: var(--color-text-on-primary); }
        .btn-secondary { background-color: var(--color-secondary); color: var(--color-text-on-primary); }
        .btn-success { background-color: var(--color-success); color: var(--color-text-on-primary); }
        
        /* Inputs e Selects */
        input, select {
            width: 100%;
            padding: calc(var(--spacing-unit) * 0.75);
            margin-bottom: var(--spacing-unit);
            border: 1px solid var(--color-background-medium);
            border-radius: var(--border-radius-soft);
            box-sizing: border-box;
            font-size: 1rem;
            background-color: var(--color-surface);
            color: var(--color-text-dark);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input:focus, select:focus {
            border-color: var(--color-primary);
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(63, 106, 216, 0.25); /* Sombra de foco com a cor prim√°ria */
        }
        input[type="checkbox"] { 
            width: auto; height: auto; transform: scale(1.1); margin-left: 5px; 
            vertical-align: middle; 
            margin-bottom: 0; 
        }
        input[readonly] { 
            background-color: var(--color-background-light); 
            cursor: not-allowed; 
            opacity: 0.8; 
        }
        
        label { 
            display: block; margin-bottom: calc(var(--spacing-unit) * 0.5); 
            font-weight: 500; 
            color: var(--color-text-dark); 
        }
        .form-group { margin-bottom: var(--spacing-unit); }
        
        /* Mensagens de Erro */
        #loginErrorMessage, #createUserErrorMessage, #changePasswordErrorMessage, #listarLoginsMessage { 
            color: var(--color-danger); 
            margin-top: var(--spacing-unit); 
            text-align: center; 
            display: none; 
            font-weight: 600; 
            background-color: rgba(220, 53, 69, 0.1); 
            padding: calc(var(--spacing-unit) * 0.5);
            border-radius: var(--border-radius-soft);
            border: 1px solid var(--color-danger);
        }

        /* Cabe√ßalho do Dashboard */
        .dashboard-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: calc(var(--spacing-unit) * 1.5); 
            flex-wrap: wrap; 
        }
        .dashboard-header div { margin-bottom: var(--spacing-unit); }
        .dashboard-header button { width: 100%; } 

        /* Wrapper de Login */
        .login-wrapper { max-width: 400px; margin: calc(var(--spacing-unit) * 3) auto; }
        .login-wrapper .app-title { font-size: 2rem; margin-bottom: calc(var(--spacing-unit) * 1.5); color: var(--color-primary); }

        /* Estilo das Tabelas de Dados */
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.9rem; 
            background-color: var(--color-surface);
        }
        .data-table th, .data-table td { 
            border: 1px solid var(--color-background-medium); 
            padding: calc(var(--spacing-unit) * 0.6); 
            text-align: left;
            /* ALTERA√á√ÉO VISUAL: Evita quebra de linha feia nas tabelas */
            white-space: nowrap;
        }
        .data-table thead th { 
            background-color: var(--color-background-medium); 
            font-weight: 600; 
            color: var(--color-text-dark);
            text-transform: uppercase; 
        }
        .data-table tbody tr:nth-child(even) { 
            background-color: var(--color-background-light);
        }
        .data-table tbody tr:hover { 
            background-color: #e2e6ea; 
            cursor: default;
        }
        
      /* ALTERA√á√ÉO VISUAL: Garante que a rolagem horizontal funcione bem */
        .card .table-responsive {
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            padding-bottom: 5px; 
            border-radius: var(--border-radius-soft); 
            border: 1px solid var(--color-background-medium);
        }

        /* Grid de Bot√µes do Admin/Usu√°rio */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
            gap: var(--spacing-unit); 
            margin-top: var(--spacing-unit);
        }
        .admin-button {
            height: 120px; 
            font-size: 0.9rem; 
            padding: 0.5rem;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background-color: var(--color-surface); 
            border: 1px solid var(--color-background-medium);
            border-radius: var(--border-radius-soft);
            text-decoration: none; 
            color: var(--color-text-dark); 
            box-shadow: var(--shadow-subtle);
        }
        .admin-button:hover {
            transform: translateY(-2px); 
            box-shadow: var(--shadow-medium);
            background-color: var(--color-background-light); 
        }
        .admin-button svg { 
            width: 38px; height: 38px; 
            margin-bottom: calc(var(--spacing-unit) * 0.5); 
            color: var(--color-primary); 
        }
        .admin-button span {
            font-weight: 500;
        }

        /* Linhas de Formul√°rio */
        .form-row { 
            display: flex; 
            gap: var(--spacing-unit); 
            flex-direction: column; 
        }
        .form-row .form-group { flex: 1; }

        /* Media Queries para Telas Maiores (Desktop/Tablet) */
        @media (min-width: 768px) {
            body { padding: calc(var(--spacing-unit) * 2); }
            .container { margin-top: calc(var(--spacing-unit) * 2.5); }
            .card { padding: calc(var(--spacing-unit) * 2); }
            h1 { font-size: 2.5rem; }
            h2 { font-size: 2rem; }
            h3 { text-align: left; font-size: 1.5rem; } 
            button { padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5); }
            .dashboard-header { flex-wrap: nowrap; }
            .dashboard-header div { margin-bottom: 0; }
            .dashboard-header button { width: auto; }
            .admin-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
                gap: calc(var(--spacing-unit) * 1.5);
                margin-top: calc(var(--spacing-unit) * 1.5);
            }
            .admin-button {
                height: 140px; 
                font-size: 1rem;
                padding: var(--spacing-unit);
            }
            .admin-button svg { 
                width: 44px; height: 44px; 
                margin-bottom: var(--spacing-unit); 
            }
            .form-row { flex-direction: row; }
            .data-table { font-size: 1rem; }
            .data-table th, .data-table td { padding: calc(var(--spacing-unit) * 0.75); }
        }
        /* Ajuste fino para o input de checkbox */
        .form-group label[for="diariaDobrou"] {
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
            margin-bottom: 0;
        }
        #diariaDobrou {
            vertical-align: middle;
            margin-top: 0;
        }

        /* Estilos espec√≠ficos para o resumo do relat√≥rio na tela */
        .report-summary-section {
            margin-top: calc(var(--spacing-unit) * 1.5);
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            padding-top: calc(var(--spacing-unit) * 0.5);
            border-top: 1px solid var(--color-background-medium);
        }
        .report-summary-section h3 {
            border-bottom: none;
            text-align: left;
            margin-bottom: calc(var(--spacing-unit) * 0.5);
            padding-bottom: 0;
            color: var(--color-text-dark);
        }
        .report-summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }
        .report-summary-table th, .report-summary-table td {
            border: 1px solid var(--color-background-medium);
            padding: calc(var(--spacing-unit) * 0.5);
            text-align: left;
        }
        .report-summary-table thead th {
            background-color: var(--color-primary);
            color: var(--color-text-on-primary);
            font-weight: 600;
            text-transform: uppercase;
        }
        .report-summary-table.payments-table thead th {
            background-color: var(--color-primary);
        }
        .report-summary-table.expenses-table thead th {
            background-color: var(--color-success);
        }
        .report-summary-table tbody tr:nth-child(even) {
            background-color: var(--color-background-light);
        }
        .report-summary-table tbody tr:hover {
            background-color: #e2e6ea;
        }
        .report-summary-table tfoot tr {
            background-color: var(--color-text-dark);
            color: var(--color-text-on-primary);
            font-weight: bold;
        }
        .report-summary-table td.text-right {
            text-align: right;
        }
        .report-summary-table th.text-right {
            text-align: right;
        }
        .report-summary-table td.text-left {
            text-align: left;
        }

        /* Bot√µes de Relat√≥rio (PDF e XLSX) */
        .report-buttons {
            display: flex;
            gap: var(--spacing-unit);
            margin-top: var(--spacing-unit);
            flex-wrap: wrap; /* Para mobile */
        }
        .report-buttons button {
            flex: 1; /* Ocupa espa√ßo igualmente */
        }
        @media (min-width: 768px) {
            .report-buttons button {
                flex: none; /* Em desktop, volta a ser o tamanho do conte√∫do */
                width: auto;
            }
        }

        /* Estilos do Modal (para Edi√ß√£o de Di√°ria) */
        .modal {
            /* CORRIGIDO: display: none por padr√£o, ser√° ativado via JS */
            display: none; 
            position: fixed; /* Fica por cima de tudo */
            z-index: 1000; /* Z-index alto para ficar na frente */
            left: 0;
            top: 0;
            width: 100%; /* Largura total */
            height: 100%; /* Altura total */
            overflow: auto; /* Habilita scroll se conte√∫do for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo semi-transparente */
            align-items: center;
            justify-content: center;
        }
        /* NOVA CLASSE: Para ativar a exibi√ß√£o do modal via JS */
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: var(--color-surface);
            margin: auto;
            padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius-soft);
            box-shadow: var(--shadow-medium);
            width: 90%;
            max-width: 500px; /* Largura m√°xima para o modal */
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-background-medium);
            padding-bottom: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
        }
        .modal-header h2 {
            margin: 0;
            color: var(--color-primary);
            text-align: left; /* T√≠tulos do modal alinhados √† esquerda */
            font-size: 1.5rem;
        }
        .close-button {
            color: var(--color-text-muted);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            margin-left: var(--spacing-unit); /* Espa√ßamento do t√≠tulo */
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--color-primary);
            text-decoration: none;
            cursor: pointer;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end; /* Alinha bot√µes √† direita */
            gap: var(--spacing-unit);
            margin-top: calc(var(--spacing-unit) * 1.5);
        }

        /* Estilos para a nova tela de Regras de Pagamento */
        .regra-item {
            background-color: var(--color-background-light);
            border: 1px solid var(--color-background-medium);
            border-radius: var(--border-radius-soft);
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 0.5);
        }
        .regra-item strong {
            font-size: 1.1rem;
            color: var(--color-primary);
            margin-bottom: calc(var(--spacing-unit) * 0.5);
            display: block;
        }
        .regra-item .regra-fields {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-unit);
        }
        .regra-item .regra-fields .form-group {
            flex: 1 1 calc(50% - var(--spacing-unit) / 2); /* 2 colunas em telas menores */
            min-width: 150px; /* Garante que n√£o fique muito pequeno */
        }
        @media (min-width: 768px) {
            .regra-item .regra-fields .form-group {
                flex: 1 1 calc(33.33% - var(--spacing-unit) * 2 / 3); /* 3 colunas em desktop */
            }
        }
        .regra-item .regra-buttons {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-unit);
            margin-top: calc(var(--spacing-unit) * 0.5);
        }
        /* Esconder campos para tipos de c√°lculo que n√£o os usam */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="mainContainer" class="container">

        <div id="screenLogin" class="screen active">
            <div class="login-wrapper">
                <h1 class="app-title">Sistema de Di√°rias</h1>
                <div class="card">
                    <h2>Login</h2>
                    <div class="form-group"><label for="loginEmail">Email:</label><input type="email" id="loginEmail"></div>
                    <div class="form-group"><label for="loginPassword">Senha:</label><input type="password" id="loginPassword"></div>
                    <button class="btn-primary" id="loginButton" style="width: 100%;">Entrar</button>
                    <div id="loginErrorMessage"></div>
                </div>
            </div>
        </div>

        <div id="screenDashboard" class="screen">
            <div class="card">
                <div class="dashboard-header">
                    <div>
                        <h2>Painel de Controle</h2>
                        <p style="margin: 0; color: var(--color-text-muted);">Logado como: <strong id="userEmailDisplay" style="color: var(--color-text-dark);"></strong></p>
                    </div>
                    <button id="logoutButton" class="btn-secondary">Sair</button>
                </div>
                
                <div id="userMainPanel"> 
                    <h3>Op√ß√µes do Sistema</h3>
                    <div class="admin-grid">
                        <button id="btnGoToLancarDiaria" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt-text">
                                <path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2Z"/>
                                <path d="M12 8h6"/>
                                <path d="M12 12h6"/>
                                <path d="M12 16h6"/>
                            </svg>
                            <span>Lan√ßar Di√°rias</span>
                        </button>
                        <button id="btnGoToListarColaboradores" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <span>Colaboradores</span>
                        </button>
                        <button id="btnGoToRelatorios" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list">
                                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                <path d="M12 11h4"/>
                                <path d="M12 15h4"/>
                                <path d="M8 11h.01"/>
                                <path d="M8 15h.01"/>
                            </svg>
                            <span>Relat√≥rios</span>
                        </button>
                        <button id="btnGoToCriarLogin" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <line x1="19" x2="19" y1="8" y2="14"/>
                                <line x1="22" x2="16" y1="11" y2="11"/>
                            </svg>
                            <span>Criar Acesso</span>
                        </button>
                        <button id="btnGoToListarLogins" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-2">
                                <path d="M14 19a6 6 0 0 0-12 0"/>
                                <circle cx="8" cy="9" r="4"/>
                                <path d="M22 19a6 6 0 0 0-12 0"/>
                                <circle cx="16" cy="9" r="4"/>
                            </svg>
                            <span>Listar Logins</span>
                        </button>
                        
                        <button id="btnGoToAlterarSenha" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-key-round">
                                <path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h3v-3h3V9h3V6c0-.6-.4-1-1-1H9c-.6 0-1 .4-1 1v3H5v3H2Z"/>
                                <path d="M7 9h.01"/>
                            </svg>
                            <span>Alterar Senha</span>
                        </button>

                        <button id="btnGoToGerenciarDiarias" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-edit">
                                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/>
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                                <path d="M9.5 16.5 16 10l-3.5-3.5L7 13l2.5 3.5Z"/>
                                <path d="M14.5 11.5 13 10"/>
                            </svg>
                            <span>Gerenciar Di√°rias</span>
                        </button>

                        <button id="btnGoToHistorico" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history">
                                <path d="M3 3v5h5"/>
                                <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>
                                <path d="M12 7v6h4"/>
                            </svg>
                            <span>Hist√≥rico</span>
                        </button>

                        <button id="btnGoToGerenciarRegras" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings">
                                <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.35a2 2 0 0 0 .73 2.73l.04.02a2 2 0 0 1 .97 2.18v.44a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 0-.73 2.73l.78 1.35a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.78-1.35a2 2 0 0 0-.73-2.73l-.04-.02a2 2 0 0 1-.97-2.18v-.44a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 0 .73-2.73l-.78-1.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            <span>Regras de Di√°ria</span>
                        </button>

                        <button id="btnGoToRelatorioColaboradores" class="admin-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-round">
                                <path d="M18 21a8 8 0 0 0-16 0"/>
                                <circle cx="10" cy="8" r="5"/>
                                <path d="M22 21a8 8 0 0 0-16 0"/>
                                <circle cx="14" cy="8" r="5"/>
                            </svg>
                            <span>Relat. Colab.</span>
                        </button>

                    </div>
                </div>
            </div>
        </div>

        <div id="screenAdicionarColaborador" class="screen"> 
            <button id="btnAdicionarColabVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar √† Lista</button> 
            <div class="card"> 
                <h2>Adicionar / Editar Colaborador</h2> 
                <div class="card"> 
                    <h3 id="colaboradorFormTitle">Adicionar Novo Colaborador</h3> 
                    <div class="form-group"><label for="colabNome">Nome Completo:</label><input type="text" id="colabNome" ></div> 
                    <div class="form-group">
                        <label for="colabFuncao">Fun√ß√£o:</label>
                        <select id="colabFuncao">
                            <option value="">-- Selecione a Fun√ß√£o --</option>
                            </select>
                    </div> 
                    <div class="form-group">
                        <label for="colabSetor">Setor:</label>
                        <select id="colabSetor">
                            <option value="">-- Selecione o Setor --</option>
                            <option value="Cozinha">Cozinha</option>
                            <option value="Sal√£o">Sal√£o</option>
                            <option value="ADM">ADM</option>
                            <option value="ASG">ASG</option>
                            <option value="Recrea√ß√£o">Recrea√ß√£o</option>
                        </select>
                    </div> 
                    <div class="form-group"><label for="colabPix">Chave PIX:</label><input type="text" id="colabPix" ></div> 
                    <div class="form-group"><label for="colabCpf">CPF:</label><input type="text" id="colabCpf" placeholder="Ex: 000.000.000-00"></div>
                    <div class="form-group"><label for="colabTelefone">Telefone:</label><input type="tel" id="colabTelefone" placeholder="Ex: (00) 90000-0000"></div>
                    <div class="form-group"><label for="colabEndereco">Endere√ßo:</label><input type="text" id="colabEndereco" placeholder="Rua, N√∫mero, Bairro, Cidade-UF"></div>
                    <div class="form-group"><label for="colabDataNascimento">Data de Nascimento:</label><input type="date" id="colabDataNascimento"></div>
                    <div class="form-group"><label for="colabNomeMae">Nome da M√£e:</label><input type="text" id="colabNomeMae"></div>
                    <button id="btnSalvarColaborador" class="btn-success">Salvar Novo Colaborador</button> 
                </div> 
            </div> 
        </div>

        <div id="screenListarColaboradores" class="screen">
            <button id="btnListarColabVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Colaboradores Cadastrados</h2>
                <button id="btnGoToAdicionarColaborador" class="btn-primary" style="margin-bottom: var(--spacing-unit);">+ Adicionar Novo Colaborador</button>
                <div class="table-responsive"> 
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome Completo</th>
                                <th>Fun√ß√£o</th>
                                <th>Setor</th>
                                <th>Chave PIX</th>
                                <th>CPF</th>
                                <th>Telefone</th>
                                <th>Endere√ßo</th>
                                <th>Nasc.</th>
                                <th>Nome M√£e</th>
                                <th>A√ß√µes</th> </tr>
                        </thead>
                        <tbody id="colaboradoresTableBody">
                            <tr><td colspan="10" style="text-align: center; padding: 20px;">Carregando colaboradores...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenLancarDiarias" class="screen">
             <button id="btnLancarDiariasVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
             <div class="card">
                 <h2>Lan√ßamento de Di√°rias</h2>
                 <div class="form-group">
                     <label for="diariaColaborador">Colaborador:</label>
                     <select id="diariaColaborador"></select>
                 </div>
                 <div class="form-row">
                     <div class="form-group">
                         <label for="diariaFuncao">Fun√ß√£o:</label>
                         <input type="text" id="diariaFuncao" readonly>
                     </div>
                     <div class="form-group">
                         <label for="diariaSetor">Setor:</label>
                         <input type="text" id="diariaSetor" readonly>
                     </div>
                 </div>
                 <div class="form-group">
                     <label for="diariaData">Data da Di√°ria:</label>
                     <input type="date" id="diariaData">
                 </div>
                 
                 <div id="diariaCamposDinamicos" style="display:none; border-top: 1px solid var(--color-background-medium); padding-top: 1rem; margin-top: 1rem;">
                     <div class="form-group">
                         <label for="diariaDobrou" style="display: inline-block; margin-right: 10px;">Dobrou o turno?</label>
                         <input type="checkbox" id="diariaDobrou">
                     </div>
                     <div class="form-row" id="diariaHorasContainer">
                         <div class="form-group">
                             <label for="diariaHoraEntrada">Hor√°rio de Entrada:</label>
                             <input type="time" id="diariaHoraEntrada">
                         </div>
                         <div class="form-group">
                             <label for="diariaHoraSaida">Hor√°rio de Sa√≠da:</label>
                             <input type="time" id="diariaHoraSaida">
                         </div>
                     </div>
                 </div>
                  <button id="btnSalvarDiaria" class="btn-success" style="width: 100%;">Lan√ßar Di√°ria</button>
             </div>
        </div>

        <div id="screenRelatorios" class="screen">
            <button id="btnRelatoriosVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Gerar Relat√≥rio de Di√°rias</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="relatorioDataInicio">Data In√≠cio:</label>
                        <input type="date" id="relatorioDataInicio">
                    </div>
                    <div class="form-group">
                        <label for="relatorioDataFim">Data Fim:</label>
                        <input type="date" id="relatorioDataFim">
                    </div>
                </div>
                <div class="report-buttons">
                    <button id="btnVerResumo" class="btn-primary">Ver Resumo na Tela</button>
                    <button id="btnGerarRelatorioXlsx" class="btn-success">Gerar XLSX</button>
                </div>

                <div id="resumoPagamentos" class="report-summary-section" style="display: none;">
                    <h3>Pagamentos por Colaborador</h3>
                    <div class="table-responsive">
                        <table class="report-summary-table payments-table">
                            <thead><tr><th>Nome Completo</th><th>Chave PIX</th><th class="text-right">Valor Total</th></tr></thead>
                            <tbody id="resumoPagamentosBody"></tbody>
                            <tfoot><tr><td colspan="2" class="text-left">Total Geral</td><td id="resumoPagamentosTotal" class="text-right"></td></tr></tfoot>
                        </table>
                    </div>
                </div>

                <div id="resumoGastos" class="report-summary-section" style="display: none;">
                    <h3>Gastos por Setor</h3>
                    <div class="table-responsive">
                        <table class="report-summary-table expenses-table">
                            <thead><tr><th>Setor</th><th class="text-right">Valor Total</th></tr></thead>
                            <tbody id="resumoGastosBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="screenCriarLogin" class="screen">
            <button id="btnCriarLoginVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Criar Novo Acesso</h2>
                <div class="form-group"><label for="createUserEmail">Email:</label><input type="email" id="createUserEmail"></div>
                <div class="form-group"><label for="generatedPasswordDisplay">Senha Gerada:</label><input type="text" id="generatedPasswordDisplay" readonly></div>
                <button class="btn-primary" id="btnCreateUser" style="width: 100%;">Gerar Senha e Criar Usu√°rio</button>
                <div id="createUserErrorMessage"></div>
            </div>
        </div>

        <div id="screenListarLogins" class="screen">
            <button id="btnListarLoginsVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Logins Cadastrados</h2>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="1" style="text-align: center; padding: 20px;">Carregando usu√°rios...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="listarLoginsMessage" style="display:none; color: var(--color-text-dark); margin-top: 1rem;"></div>
            </div>
        </div>

        <div id="screenAlterarSenha" class="screen">
            <button id="btnAlterarSenhaVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Alterar Minha Senha</h2>
                <div class="form-group"><label for="currentPassword">Senha Atual:</label><input type="password" id="currentPassword"></div>
                <div class="form-group"><label for="newPassword">Nova Senha:</label><input type="password" id="newPassword"></div>
                <div class="form-group"><label for="confirmNewPassword">Confirmar Nova Senha:</label><input type="password" id="confirmNewPassword"></div>
                <button class="btn-primary" id="btnChangePassword" style="width: 100%;">Alterar Senha</button>
                <div id="changePasswordErrorMessage"></div>
            </div>
        </div>

        <div id="screenGerenciarDiarias" class="screen">
            <button id="btnGerenciarDiariasVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Gerenciar Di√°rias Lan√ßadas</h2>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Colaborador</th> <th>Data</th>
                                <th>Fun√ß√£o</th>
                                <th>Setor</th>
                                <th>Valor</th>
                                <th>Lan√ßado Por</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="gerenciarDiariasTableBody">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">Carregando di√°rias...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="editDiariaModal" class="modal"> 
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Editar Di√°ria</h2>
                        <span class="close-button">&times;</span>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editDiariaId">
                        <div class="form-group"><label for="editDiariaColaboradorNome">Colaborador:</label><input type="text" id="editDiariaColaboradorNome" readonly></div>
                        <div class="form-group"><label for="editDiariaData">Data da Di√°ria:</label><input type="date" id="editDiariaData"></div>
                        <div class="form-group">
                            <label for="editDiariaFuncao">Fun√ß√£o:</label>
                            <select id="editDiariaFuncao">
                                </select>
                        </div>
                        <div class="form-group">
                            <label for="editDiariaSetor">Setor:</label>
                            <select id="editDiariaSetor">
                                <option value="Cozinha">Cozinha</option>
                                <option value="Sal√£o">Sal√£o</option>
                                <option value="ADM">ADM</option>
                                <option value="ASG">ASG</option>
                                <option value="Recrea√ß√£o">Recrea√ß√£o</option>
                            </select>
                        </div>
                        <div id="editDiariaCamposDinamicos" style="display: none;"> 
                            <div class="form-group">
                                <label for="editDiariaDobrou" style="display: inline-block; margin-right: 10px;">Dobrou o turno?</label>
                                <input type="checkbox" id="editDiariaDobrou">
                            </div>
                            <div class="form-row" id="editDiariaHorasContainer">
                                <div class="form-group">
                                    <label for="editDiariaHoraEntrada">Hor√°rio de Entrada:</label>
                                    <input type="time" id="editDiariaHoraEntrada">
                                </div>
                                <div class="form-group">
                                    <label for="editDiariaHoraSaida">Hor√°rio de Sa√≠da:</label>
                                    <input type="time" id="editDiariaHoraSaida">
                                </div>
                            </div>
                        </div>
                        <div class="form-group"><label for="editDiariaValor">Valor (R$):</label><input type="number" id="editDiariaValor" step="0.01"></div>
                    </div>
                    <div class="modal-buttons">
                        <button id="cancelEditDiariaButton" class="btn-secondary">Cancelar</button>
                        <button id="saveEditDiariaButton" class="btn-success">Salvar Altera√ß√µes</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="screenHistorico" class="screen">
            <button id="btnHistoricoVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Hist√≥rico de Di√°rias</h2>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usu√°rio</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="historicoTableBody">
                            <tr><td colspan="3" style="text-align: center; padding: 20px;">Carregando hist√≥rico...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="screenGerenciarRegras" class="screen">
            <button id="btnGerenciarRegrasVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Gerenciar Regras de Pagamento de Di√°rias</h2>
                <button id="btnAdicionarNovaRegra" class="btn-primary" style="margin-bottom: var(--spacing-unit);">+ Adicionar Nova Regra</button>
                <div id="regrasPagamentoList">
                    <p style="text-align: center;">Carregando regras...</p>
                </div>
            </div>
        </div>

        <div id="screenRelatorioColaboradores" class="screen">
            <button id="btnRelatorioColaboradoresVoltar" class="btn-secondary" style="margin-bottom: 1.5rem;">&larr; Voltar ao Painel</button>
            <div class="card">
                <h2>Relat√≥rio de Colaboradores</h2>
                <button id="btnGerarRelatorioColaboradoresPdf" class="btn-success" style="margin-bottom: var(--spacing-unit);">Gerar PDF</button>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Fun√ß√£o</th>
                                <th>Setor</th>
                                <th>PIX</th>
                                <th>CPF</th>
                                <th>Telefone</th>
                                <th>Endere√ßo</th>
                                <th>Nasc.</th>
                                <th>M√£e</th>
                            </tr>
                        </thead>
                        <tbody id="relatorioColaboradoresTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VARI√ÅVEIS GLOBAIS ---
            const SUPABASE_URL = 'https://pbgnhcwspgvqcwlbbxle.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBiZ25oY3dzcGd2cWN3bGJieGxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNTQwNjksImV4cCI6MjA2NjkzMDA2OX0.9wOVZGObGwmL5T1qLkxOA2Ktm9TmW-zBPQnyn94vYSo';
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // ID do administrador mestre (ATUALIZE ESTE ID com o do seu usu√°rio admin no Supabase!)
            // Isso controla a VISIBILIDADE dos bot√µes de ADMIN no frontend.
            // A SEGURAN√áA REAL das opera√ß√µes √© controlada pelas Pol√≠ticas de RLS no Supabase!
            const ADMIN_USER_ID = 'bf164038-826a-45df-be61-c81ea2f0cc5f'; 

            let editingColaboradorId = null; 
            let regras_pagamento = [];
            let colaboradoresCache = []; // Vari√°vel global para cache de colaboradores

            // --- SELETORES DE ELEMENTOS ---
            // Telas
            const screens = document.querySelectorAll('.screen');
            const screenLogin = document.getElementById('screenLogin');
            const screenDashboard = document.getElementById('screenDashboard');
            const screenAdicionarColaborador = document.getElementById('screenAdicionarColaborador');
            const screenListarColaboradores = document.getElementById('screenListarColaboradores');
            const screenLancarDiarias = document.getElementById('screenLancarDiarias');
            const screenRelatorios = document.getElementById('screenRelatorios');
            const screenCriarLogin = document.getElementById('screenCriarLogin');
            const screenListarLogins = document.getElementById('screenListarLogins');
            const screenAlterarSenha = document.getElementById('screenAlterarSenha');
            const screenGerenciarDiarias = document.getElementById('screenGerenciarDiarias');
            const screenHistorico = document.getElementById('screenHistorico');
            const screenGerenciarRegras = document.getElementById('screenGerenciarRegras');
            const screenRelatorioColaboradores = document.getElementById('screenRelatorioColaboradores');

            // Login
            const loginEmailInput = document.getElementById('loginEmail');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginButton = document.getElementById('loginButton');
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const logoutButton = document.getElementById('logoutButton');

            // Dashboard
            const userMainPanel = document.getElementById('userMainPanel');
            const btnGoToLancarDiaria = document.getElementById('btnGoToLancarDiaria');
            const btnGoToListarColaboradores = document.getElementById('btnGoToListarColaboradores');
            const btnGoToRelatorios = document.getElementById('btnGoToRelatorios');
            const btnGoToCriarLogin = document.getElementById('btnGoToCriarLogin');
            const btnGoToListarLogins = document.getElementById('btnGoToListarLogins');
            const btnGoToAlterarSenha = document.getElementById('btnGoToAlterarSenha');
            const btnGoToGerenciarDiarias = document.getElementById('btnGoToGerenciarDiarias');
            const btnGoToHistorico = document.getElementById('btnGoToHistorico');
            const btnGoToGerenciarRegras = document.getElementById('btnGoToGerenciarRegras');
            const btnGoToRelatorioColaboradores = document.getElementById('btnGoToRelatorioColaboradores');

            // Adicionar/Editar Colaborador
            const colaboradorFormTitle = document.getElementById('colaboradorFormTitle');
            const colabNomeInput = document.getElementById('colabNome');
            const colabFuncaoSelect = document.getElementById('colabFuncao');
            const colabSetorSelect = document.getElementById('colabSetor');
            const colabPixInput = document.getElementById('colabPix');
            const colabCpfInput = document.getElementById('colabCpf');
            const colabTelefoneInput = document.getElementById('colabTelefone');
            const colabEnderecoInput = document.getElementById('colabEndereco');
            const colabDataNascimentoInput = document.getElementById('colabDataNascimento');
            const colabNomeMaeInput = document.getElementById('colabNomeMae');
            const btnSalvarColaborador = document.getElementById('btnSalvarColaborador');
            const btnAdicionarColabVoltar = document.getElementById('btnAdicionarColabVoltar');
            const btnListarColabVoltar = document.getElementById('btnListarColabVoltar');

            // Listar Colaboradores
            const colaboradoresTableBody = document.getElementById('colaboradoresTableBody');
            const btnGoToAdicionarColaborador = document.getElementById('btnGoToAdicionarColaborador');

            // Lan√ßar Di√°rias
            const diariaColaboradorSelect = document.getElementById('diariaColaborador');
            const diariaFuncaoInput = document.getElementById('diariaFuncao');
            const diariaSetorInput = document.getElementById('diariaSetor');
            const diariaDataInput = document.getElementById('diariaData');
            const diariaCamposDinamicos = document.getElementById('diariaCamposDinamicos');
            const diariaDobrouCheckbox = document.getElementById('diariaDobrou');
            const diariaHorasContainer = document.getElementById('diariaHorasContainer');
            const diariaHoraEntradaInput = document.getElementById('diariaHoraEntrada');
            const diariaHoraSaidaInput = document.getElementById('diariaHoraSaida');
            const btnSalvarDiaria = document.getElementById('btnSalvarDiaria');
            const btnLancarDiariasVoltar = document.getElementById('btnLancarDiariasVoltar');

            // Relat√≥rios
            const relatorioDataInicioInput = document.getElementById('relatorioDataInicio');
            const relatorioDataFimInput = document.getElementById('relatorioDataFim');
            const btnVerResumo = document.getElementById('btnVerResumo');
            const btnGerarRelatorioXlsx = document.getElementById('btnGerarRelatorioXlsx');
            const btnRelatoriosVoltar = document.getElementById('btnRelatoriosVoltar');
            const resumoPagamentosDiv = document.getElementById('resumoPagamentos');
            const resumoPagamentosBody = document.getElementById('resumoPagamentosBody');
            const resumoPagamentosTotal = document.getElementById('resumoPagamentosTotal');
            const resumoGastosDiv = document.getElementById('resumoGastos');
            const resumoGastosBody = document.getElementById('resumoGastosBody');
            
            // Criar Login
            const createUserEmailInput = document.getElementById('createUserEmail');
            const generatedPasswordDisplay = document.getElementById('generatedPasswordDisplay');
            const btnCreateUser = document.getElementById('btnCreateUser');
            const createUserErrorMessage = document.getElementById('createUserErrorMessage');
            const btnCriarLoginVoltar = document.getElementById('btnCriarLoginVoltar');

            // Listar Logins
            const usersTableBody = document.getElementById('usersTableBody');
            const listarLoginsMessage = document.getElementById('listarLoginsMessage');
            const btnListarLoginsVoltar = document.getElementById('btnListarLoginsVoltar');

            // Alterar Senha
            const currentPasswordInput = document.getElementById('currentPassword'); 
            const newPasswordInput = document.getElementById('newPassword');
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
            const btnChangePassword = document.getElementById('btnChangePassword');
            const changePasswordErrorMessage = document.getElementById('changePasswordErrorMessage');
            const btnAlterarSenhaVoltar = document.getElementById('btnAlterarSenhaVoltar');

            // Gerenciar Di√°rias
            const gerenciarDiariasTableBody = document.getElementById('gerenciarDiariasTableBody');
            const btnGerenciarDiariasVoltar = document.getElementById('btnGerenciarDiariasVoltar');
            const editDiariaModal = document.getElementById('editDiariaModal');
            const closeEditModalButton = editDiariaModal.querySelector('.close-button');
            const editDiariaIdInput = document.getElementById('editDiariaId');
            const editDiariaColaboradorNomeInput = document.getElementById('editDiariaColaboradorNome');
            const editDiariaDataInput = document.getElementById('editDiariaData');
            const editDiariaFuncaoSelect = document.getElementById('editDiariaFuncao');
            const editDiariaSetorSelect = document.getElementById('editDiariaSetor');
            const editDiariaValorInput = document.getElementById('editDiariaValor');
            const editDiariaCamposDinamicos = document.getElementById('editDiariaCamposDinamicos');
            const editDiariaDobrouCheckbox = document.getElementById('editDiariaDobrou');
            const editDiariaHorasContainer = document.getElementById('editDiariaHorasContainer');
            const editDiariaHoraEntradaInput = document.getElementById('editDiariaHoraEntrada');
            const editDiariaHoraSaidaInput = document.getElementById('editDiariaHoraSaida');
            const cancelEditDiariaButton = document.getElementById('cancelEditDiariaButton');
            const saveEditDiariaButton = document.getElementById('saveEditDiariaButton');

            // Hist√≥rico
            const historicoTableBody = document.getElementById('historicoTableBody');
            const btnHistoricoVoltar = document.getElementById('btnHistoricoVoltar');

            // Gerenciar Regras
            const regrasPagamentoList = document.getElementById('regrasPagamentoList');
            const btnGerenciarRegrasVoltar = document.getElementById('btnGerenciarRegrasVoltar');
            const btnAdicionarNovaRegra = document.getElementById('btnAdicionarNovaRegra'); // NOVO

            // Relat√≥rio Colaboradores
            const relatorioColaboradoresTableBody = document.getElementById('relatorioColaboradoresTableBody');
            const btnRelatorioColaboradoresVoltar = document.getElementById('btnRelatorioColaboradoresVoltar');
            const btnGerarRelatorioColaboradoresPdf = document.getElementById('btnGerarRelatorioColaboradoresPdf');

            // --- FUN√á√ïES DE NAVEGA√á√ÉO E UI ---
            function showScreen(screenId) {
                screens.forEach(screen => {
                    screen.classList.remove('active');
                });
                const activeScreen = document.getElementById(`screen${screenId.charAt(0).toUpperCase() + screenId.slice(1)}`);
                if (activeScreen) {
                    activeScreen.classList.add('active');
                } else {
                    console.error(`Tela com ID 'screen${screenId.charAt(0).toUpperCase() + screenId.slice(1)}' n√£o encontrada.`);
                }
            }

            // --- FUN√á√ïES DE AUTENTICA√á√ÉO ---
            async function handleLogin() {
                const email = loginEmailInput.value;
                const password = loginPasswordInput.value;
                loginErrorMessage.style.display = 'none';

                const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    loginErrorMessage.textContent = `Erro de login: ${error.message}`;
                    loginErrorMessage.style.display = 'block';
                    console.error("Erro no login:", error);
                } else if (data.user) {
                    await setupDashboard(data.user);
                }
            }

            async function handleLogout() {
                const { error } = await _supabase.auth.signOut();
                if (error) {
                    alert(`Erro ao sair: ${error.message}`);
                } else {
                    showScreen('login');
                }
            }

            async function setupDashboard(user) {
                userEmailDisplay.textContent = user.email;
                const isAdmin = user.id === ADMIN_USER_ID;

                // Esconde/mostra bot√µes de admin
                btnGoToCriarLogin.style.display = isAdmin ? 'flex' : 'none';
                btnGoToListarLogins.style.display = isAdmin ? 'flex' : 'none';
                btnGoToGerenciarRegras.style.display = isAdmin ? 'flex' : 'none';

                // Carrega dados essenciais
                await fetchRegrasPagamento();
                await fetchAndRenderColaboradores(true); // Popula o cache ao iniciar o dashboard
                
                showScreen('dashboard');
            }

            // --- FUN√á√ïES DE COLABORADORES ---
            async function fetchAndRenderColaboradores(populateCacheOnly = false) {
                if (!populateCacheOnly) {
                    colaboradoresTableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Carregando colaboradores...</td></tr>';
                }
                const { data, error } = await _supabase.from('colaboradores').select('*').order('nome_completo');
                if (error) {
                    console.error("Erro ao buscar colaboradores:", error);
                    alert("Erro ao carregar colaboradores.");
                    if (!populateCacheOnly) {
                        colaboradoresTableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Erro ao carregar.</td></tr>';
                    }
                    return;
                }
                colaboradoresCache = data; // Popula o cache

                if (!populateCacheOnly) {
                    renderColaboradoresTable(data);
                }
            }

            function renderColaboradoresTable(colaboradores) {
                colaboradoresTableBody.innerHTML = '';
                if (colaboradores.length === 0) {
                    colaboradoresTableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">Nenhum colaborador cadastrado.</td></tr>';
                    return;
                }
                colaboradores.forEach(colab => {
                    const row = colaboradoresTableBody.insertRow();
                    row.innerHTML = `
                        <td>${colab.nome_completo}</td>
                        <td>${colab.funcao}</td>
                        <td>${colab.setor}</td>
                        <td>${colab.chave_pix || 'N/A'}</td>
                        <td>${formatCpf(colab.cpf) || 'N/A'}</td>
                        <td>${formatTelefone(colab.telefone) || 'N/A'}</td>
                        <td>${colab.endereco || 'N/A'}</td>
                        <td>${colab.data_nascimento ? new Date(colab.data_nascimento + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'N/A'}</td>
                        <td>${colab.nome_mae || 'N/A'}</td>
                        <td><button class="btn-secondary edit-colab-btn" data-id="${colab.id}">Editar</button></td>
                    `;
                });
                document.querySelectorAll('.edit-colab-btn').forEach(button => {
                    button.addEventListener('click', (e) => handleEditColaborador(e.target.dataset.id));
                });
            }

            async function handleEditColaborador(id) {
                const { data, error } = await _supabase.from('colaboradores').select('*').eq('id', id).single();
                if (error) {
                    console.error("Erro ao buscar colaborador para edi√ß√£o:", error);
                    alert("Erro ao carregar dados do colaborador.");
                    return;
                }
                editingColaboradorId = id;
                colaboradorFormTitle.textContent = 'Editar Colaborador';
                btnSalvarColaborador.textContent = 'Salvar Altera√ß√µes';
                btnSalvarColaborador.classList.remove('btn-success');
                btnSalvarColaborador.classList.add('btn-primary');

                colabNomeInput.value = data.nome_completo;
                colabFuncaoSelect.value = data.funcao;
                colabSetorSelect.value = data.setor;
                colabPixInput.value = data.chave_pix;
                colabCpfInput.value = formatCpf(data.cpf);
                colabTelefoneInput.value = formatTelefone(data.telefone);
                colabEnderecoInput.value = data.endereco;
                colabDataNascimentoInput.value = data.data_nascimento;
                colabNomeMaeInput.value = data.nome_mae;

                showScreen('adicionarColaborador');
            }

            async function handleSalvarColaborador() {
                const nome = colabNomeInput.value.trim();
                const funcao = colabFuncaoSelect.value;
                const setor = colabSetorSelect.value;
                const pix = colabPixInput.value.trim();
                const cpf = colabCpfInput.value.replace(/\D/g, ''); 
                const telefone = colabTelefoneInput.value.replace(/\D/g, ''); 
                const endereco = colabEnderecoInput.value.trim();
                const dataNascimento = colabDataNascimentoInput.value || null;
                const nomeMae = colabNomeMaeInput.value.trim();

                if (!nome || !funcao || !setor) {
                    alert('Nome, Fun√ß√£o e Setor s√£o obrigat√≥rios.');
                    return;
                }

                const colabData = {
                    nome_completo: nome,
                    funcao: funcao,
                    setor: setor,
                    chave_pix: pix,
                    cpf: cpf,
                    telefone: telefone,
                    endereco: endereco,
                    data_nascimento: dataNascimento,
                    nome_mae: nomeMae
                };

                let result;
                if (editingColaboradorId) {
                    result = await _supabase.from('colaboradores').update(colabData).eq('id', editingColaboradorId);
                } else {
                    result = await _supabase.from('colaboradores').insert([colabData]);
                }

                if (result.error) {
                    console.error("Erro ao salvar colaborador:", result.error);
                    alert(`Erro ao salvar: ${result.error.message}`);
                } else {
                    alert(`Colaborador ${editingColaboradorId ? 'atualizado' : 'adicionado'} com sucesso!`);
                    editingColaboradorId = null;
                    await fetchAndRenderColaboradores(); // Atualiza o cache e a tabela
                    showScreen('listarColaboradores');
                }
            }

            // --- FUN√á√ïES DE DI√ÅRIAS ---
            async function showLancarDiariasScreen() {
                // Garante que o cache de colaboradores est√° preenchido
                if (colaboradoresCache.length === 0) {
                    await fetchAndRenderColaboradores(true); // 'true' para apenas popular o cache
                }

                if (colaboradoresCache.length === 0) {
                    alert("N√£o foi poss√≠vel carregar a lista de colaboradores. Tente voltar e entrar na tela novamente.");
                    return;
                }

                // Popula o dropdown usando o cache que agora est√° completo
                diariaColaboradorSelect.innerHTML = '<option value="">-- Selecione o Colaborador --</option>';
                colaboradoresCache.forEach(colab => {
                    diariaColaboradorSelect.innerHTML += `<option value="${colab.id}">${colab.nome_completo}</option>`;
                });

                // Reseta os campos do formul√°rio
                diariaColaboradorSelect.value = '';
                diariaDataInput.valueAsDate = new Date();
                diariaFuncaoInput.value = '';
                diariaSetorInput.value = '';
                diariaDobrouCheckbox.checked = false;
                diariaHoraEntradaInput.value = '';
                diariaHoraSaidaInput.value = '';
                diariaCamposDinamicos.style.display = 'none';
                
                showScreen('lancarDiarias');
            }

            async function toggleDiariaFields(isEdit) {
                const selectColabElement = isEdit ? null : diariaColaboradorSelect;
                const funcaoSelectOrInput = isEdit ? editDiariaFuncaoSelect : diariaFuncaoInput;
                const setorSelectOrInput = isEdit ? editDiariaSetorSelect : diariaSetorInput;
                const camposDinamicosDiv = isEdit ? editDiariaCamposDinamicos : diariaCamposDinamicos;
                const dobrouCheckbox = isEdit ? editDiariaDobrouCheckbox : diariaDobrouCheckbox;
                const horasContainer = isEdit ? editDiariaHorasContainer : diariaHorasContainer;
                const valorInput = isEdit ? editDiariaValorInput : null;

                let selectedFuncao;
                if (isEdit) {
                    selectedFuncao = funcaoSelectOrInput.value; // Em edi√ß√£o, a fun√ß√£o j√° vem do banco
                } else {
                    const selectedColabId = selectColabElement.value;
                    if (!selectedColabId) {
                        funcaoSelectOrInput.value = '';
                        setorSelectOrInput.value = '';
                        camposDinamicosDiv.style.display = 'none';
                        return;
                    }
                    const selectedColab = colaboradoresCache.find(c => c.id === selectedColabId);
                    if (selectedColab) {
                        selectedFuncao = selectedColab.funcao;
                        funcaoSelectOrInput.value = selectedFuncao;
                        setorSelectOrInput.value = selectedColab.setor;
                    } else {
                        funcaoSelectOrInput.value = '';
                        setorSelectOrInput.value = '';
                        camposDinamicosDiv.style.display = 'none';
                        return;
                    }
                }
                
                const regra = regras_pagamento.find(r => r.funcao === selectedFuncao);

                if (regra && regra.tipo_calculo === 'Fixo com Dobra') {
                    camposDinamicosDiv.style.display = 'block';
                    horasContainer.style.display = dobrouCheckbox.checked ? 'none' : 'flex';
                } else {
                    camposDinamicosDiv.style.display = 'none';
                    // Limpa campos de hora se a regra n√£o for de horas
                    if (!isEdit) { // Apenas para o formul√°rio de lan√ßamento
                        diariaHoraEntradaInput.value = '';
                        diariaHoraSaidaInput.value = '';
                        diariaDobrouCheckbox.checked = false;
                    }
                }
                
                // Se estiver em edi√ß√£o, recalcule e preencha o valor
                if (isEdit) {
                    const calculated = calculateDiariaValue(true);
                    valorInput.value = calculated.valorCalculado.toFixed(2);
                }
            }

            function calculateDiariaValue(isEdit) {
                const funcao = isEdit ? editDiariaFuncaoSelect.value : diariaFuncaoInput.value;
                const dataInput = isEdit ? editDiariaDataInput : diariaDataInput;
                const dobrouCheckbox = isEdit ? editDiariaDobrouCheckbox : diariaDobrouCheckbox;
                const horaEntradaInput = isEdit ? editDiariaHoraEntradaInput : diariaHoraEntradaInput;
                const horaSaidaInput = isEdit ? editDiariaHoraSaidaInput : diariaHoraSaidaInput;

                const regra = regras_pagamento.find(r => r.funcao === funcao);
                if (!regra) {
                    return { valorCalculado: 0, horasTrabalhadas: 0 };
                }

                let valorFinal = 0;
                let horasTrabalhadas = 0;
                const diaDaSemana = new Date(dataInput.value + 'T00:00:00').getDay(); // 0=Domingo, 6=S√°bado
                const isFDS = diaDaSemana === 0 || diaDaSemana === 6;

                if (regra.tipo_calculo === 'Fixo') {
                    valorFinal = regra.valor_base || 0;
                    // Para di√°rias fixas, assumimos 8 horas trabalhadas para simplificar ou um valor padr√£o.
                    // Ajuste conforme a l√≥gica do seu neg√≥cio.
                    horasTrabalhadas = 8; 
                } else if (regra.tipo_calculo === 'Fixo com Dobra') {
                    if (dobrouCheckbox.checked) {
                        valorFinal = isFDS ? (regra.valor_dobra_fds || 0) : (regra.valor_dobra_semana || 0);
                        horasTrabalhadas = (regra.horas_base || 0) * 2; // Assumindo o dobro de horas se dobrou
                    } else {
                        valorFinal = regra.valor_base || 0;
                        horasTrabalhadas = 0; // Ser√° calculado abaixo se hor√°rios forem preenchidos

                        const entrada = horaEntradaInput.value;
                        const saida = horaSaidaInput.value;

                        if (entrada && saida) {
                            // Criar objetos Date para o c√°lculo, usando uma data base para evitar problemas
                            const [heHours, heMinutes] = entrada.split(':').map(Number);
                            const [hsHours, hsMinutes] = saida.split(':').map(Number);

                            let start = new Date(0, 0, 0, heHours, heMinutes, 0);
                            let end = new Date(0, 0, 0, hsHours, hsMinutes, 0);

                            // Se a hora de sa√≠da for menor que a de entrada, significa que virou o dia
                            if (end < start) {
                                end.setDate(end.getDate() + 1); // Adiciona um dia
                            }

                            const diffMs = end - start;
                            const diffHours = diffMs / (1000 * 60 * 60); // Diferen√ßa em horas

                            horasTrabalhadas = diffHours;
                            
                            const horasBaseRegra = regra.horas_base || 0;
                            const valorHoraExtraRegra = regra.valor_hora_extra || 0;

                            if (horasTrabalhadas > horasBaseRegra) {
                                const horasExtras = horasTrabalhadas - horasBaseRegra;
                                valorFinal += horasExtras * valorHoraExtraRegra;
                            }
                        } else {
                            // Se n√£o informou hor√°rio, mas n√£o dobrou, ainda pode ser o valor base
                            horasTrabalhadas = regra.horas_base || 0;
                        }
                    }
                }
                return { valorCalculado: parseFloat(valorFinal.toFixed(2)), horasTrabalhadas: parseFloat(horasTrabalhadas.toFixed(2)) };
            }

            async function handleSalvarDiaria() {
                const colaboradorId = diariaColaboradorSelect.value;
                const dataDiaria = diariaDataInput.value;

                if (!colaboradorId || !dataDiaria) {
                    alert('Por favor, selecione um colaborador e uma data.');
                    return;
                }

                const { data: { user } } = await _supabase.auth.getUser();
                const { valorCalculado, horasTrabalhadas } = calculateDiariaValue(false);
                const colaboradorSelecionado = colaboradoresCache.find(c => c.id === colaboradorId);

                if (!colaboradorSelecionado) {
                    alert('Erro: Colaborador n√£o encontrado no cache. Recarregue a p√°gina.');
                    return;
                }

                const diariaData = {
                    colaborador_id: colaboradorId,
                    data_diaria: dataDiaria,
                    valor_pago: valorCalculado, 
                    funcao_colaborador: colaboradorSelecionado.funcao, 
                    setor_colaborador: colaboradorSelecionado.setor, 
                    user_id: user.id,
                    dobrou: diariaDobrouCheckbox.checked,
                    horario_entrada: diariaHoraEntradaInput.value || null,
                    horario_saida: diariaHoraSaidaInput.value || null,
                    horas_trabalhadas: horasTrabalhadas,
                    lancado_por: user.email 
                };

                const { data, error } = await _supabase.from('diarias_lancadas').insert([diariaData]).select().single();
                if (error) {
                    console.error("Erro ao salvar di√°ria:", error);
                    alert(`Erro ao salvar di√°ria: ${error.message}`);
                } else {
                    await logAction('CREATED', data.id, user.email, `Di√°ria de ${colaboradorSelecionado.nome_completo} (R$ ${data.valor_pago.toFixed(2)}) criada.`); 
                    alert('Di√°ria lan√ßada com sucesso!');
                    // Limpa o formul√°rio ap√≥s o lan√ßamento
                    diariaColaboradorSelect.value = '';
                    diariaDataInput.valueAsDate = new Date();
                    diariaFuncaoInput.value = '';
                    diariaSetorInput.value = '';
                    diariaDobrouCheckbox.checked = false;
                    diariaHoraEntradaInput.value = '';
                    diariaHoraSaidaInput.value = '';
                    diariaCamposDinamicos.style.display = 'none';
                    // Poder√≠amos voltar para o dashboard ou permitir outro lan√ßamento
                    showScreen('dashboard'); 
                }
            }

            // --- FUN√á√ïES DE RELAT√ìRIOS ---
            function showRelatoriosScreen() {
                relatorioDataInicioInput.valueAsDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                relatorioDataFimInput.valueAsDate = new Date();
                resumoPagamentosDiv.style.display = 'none';
                resumoGastosDiv.style.display = 'none';
                showScreen('relatorios');
            }

            async function processarDadosRelatorio(dataInicio, dataFim) {
                const { data: diarias, error } = await _supabase.from('diarias_lancadas')
                    .select(`*, colaboradores(nome_completo, chave_pix)`)
                    .gte('data_diaria', dataInicio)
                    .lte('data_diaria', dataFim);
                
                if (error) {
                    console.error("Erro ao buscar di√°rias para relat√≥rio:", error);
                    alert("Erro ao gerar relat√≥rio.");
                    return null;
                }

                if (diarias.length === 0) {
                    alert('Nenhuma di√°ria encontrada no per√≠odo selecionado.');
                    return null;
                }

                const pagamentos = {};
                const gastosPorSetor = {};

                diarias.forEach(d => {
                    // Processa pagamentos
                    const nome = d.colaboradores ? d.colaboradores.nome_completo : 'Desconhecido';
                    const pix = d.colaboradores ? d.colaboradores.chave_pix : 'N/A';
                    const valorDiaria = d.valor_pago || 0; 
                    
                    if (!pagamentos[nome]) {
                        pagamentos[nome] = { valor: 0, pix: pix };
                    }
                    pagamentos[nome].valor += valorDiaria;

                    // Processa gastos por setor
                    const setor = d.setor_colaborador || 'N√£o Informado'; 
                    if (!gastosPorSetor[setor]) {
                        gastosPorSetor[setor] = 0;
                    }
                    gastosPorSetor[setor] += valorDiaria;
                });

                return { diarias, pagamentos, gastosPorSetor };
            }

            function exibirResumoNaTela(dados) {
                // Preenche tabela de pagamentos
                resumoPagamentosBody.innerHTML = '';
                let totalPagamentos = 0;
                Object.entries(dados.pagamentos).sort((a, b) => a[0].localeCompare(b[0])).forEach(([nome, info]) => {
                    const row = resumoPagamentosBody.insertRow();
                    row.innerHTML = `
                        <td>${nome}</td>
                        <td>${info.pix || 'N/A'}</td>
                        <td class="text-right">${info.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    `;
                    totalPagamentos += info.valor;
                });
                resumoPagamentosTotal.textContent = totalPagamentos.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                resumoPagamentosDiv.style.display = 'block';

                // Preenche tabela de gastos
                resumoGastosBody.innerHTML = '';
                Object.entries(dados.gastosPorSetor).sort((a, b) => a[0].localeCompare(b[0])).forEach(([setor, valor]) => {
                    const row = resumoGastosBody.insertRow(); 
                    row.innerHTML = `
                        <td>${setor}</td>
                        <td class="text-right">${valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    `;
                });
                resumoGastosDiv.style.display = 'block';
            }

            async function gerarRelatorioXlsx() {
                const dataInicio = relatorioDataInicioInput.value;
                const dataFim = relatorioDataFimInput.value;
                if (!dataInicio || !dataFim) {
                    alert('Por favor, selecione as datas de in√≠cio e fim para o relat√≥rio.');
                    return;
                }
                const dados = await processarDadosRelatorio(dataInicio, dataFim);
                if (!dados) return;

                const { diarias, pagamentos, gastosPorSetor } = dados;

                // Aba 1: Di√°rias Detalhadas
                const ws_diarias_data = [
                    ["Data", "Colaborador", "Fun√ß√£o", "Setor", "Valor (R$)", "Dobrou", "Hor√°rio Entrada", "Hor√°rio Sa√≠da", "Horas Trabalhadas", "Lan√ßado Por"],
                    ...diarias.map(d => [
                        new Date(d.data_diaria + 'T00:00:00').toLocaleDateString('pt-BR'),
                        d.colaboradores ? d.colaboradores.nome_completo : 'Desconhecido',
                        d.funcao_colaborador, 
                        d.setor_colaborador, 
                        d.valor_pago, 
                        d.dobrou ? 'Sim' : 'N√£o',
                        d.horario_entrada || '',
                        d.horario_saida || '',
                        d.horas_trabalhadas || 0,
                        d.lancado_por || 'N/A'
                    ])
                ];
                const ws_diarias = XLSX.utils.aoa_to_sheet(ws_diarias_data);

                // Aba 2: Resumo de Pagamentos
                const ws_pagamentos_data = [
                    ["Colaborador", "Chave PIX", "Valor Total (R$)"],
                    ...Object.entries(pagamentos).map(([nome, info]) => [nome, info.pix, info.valor])
                ];
                const ws_pagamentos = XLSX.utils.aoa_to_sheet(ws_pagamentos_data);

                // Aba 3: Resumo de Gastos por Setor
                const ws_gastos_data = [
                    ["Setor", "Gasto Total (R$)"],
                    ...Object.entries(gastosPorSetor).map(([setor, valor]) => [setor, valor])
                ];
                const ws_gastos = XLSX.utils.aoa_to_sheet(ws_gastos_data);

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws_diarias, "Di√°rias Detalhadas");
                XLSX.utils.book_append_sheet(wb, ws_pagamentos, "Resumo de Pagamentos");
                XLSX.utils.book_append_sheet(wb, ws_gastos, "Gastos por Setor");

                XLSX.writeFile(wb, `Relatorio_Diarias_${dataInicio}_a_${dataFim}.xlsx`);
                alert('Relat√≥rio XLSX gerado com sucesso!');
            }

            // --- FUN√á√ïES DE ADMINISTRA√á√ÉO DE USU√ÅRIOS ---
            async function handleCreateUser() {
                const email = createUserEmailInput.value;
                if (!email) {
                    alert("Por favor, insira um email.");
                    return;
                }
                const password = Math.random().toString(36).slice(-8); // Senha aleat√≥ria
                generatedPasswordDisplay.value = password;
                createUserErrorMessage.style.display = 'none';

                const { data, error } = await _supabase.auth.signUp({ email, password });

                if (error) {
                    createUserErrorMessage.textContent = `Erro: ${error.message}`;
                    createUserErrorMessage.style.display = 'block';
                } else {
                    alert(`Usu√°rio ${email} criado com sucesso! A senha √©: ${password}. Guarde esta senha em um local seguro.`);
                    createUserEmailInput.value = '';
                    generatedPasswordDisplay.value = '';
                }
            }

            async function showListarLoginsScreen() {
                usersTableBody.innerHTML = '<tr><td style="text-align: center; padding: 20px;">Carregando usu√°rios...</td></tr>';
                listarLoginsMessage.style.display = 'none';
                showScreen('listarLogins');

                const { data: { users }, error } = await _supabase.auth.admin.listUsers();
                if (error) {
                    // Mensagem de erro mais clara sobre a permiss√£o
                    listarLoginsMessage.textContent = `Erro ao listar usu√°rios: ${error.message}. Esta opera√ß√£o requer permiss√µes de administrador (Service Role Key) e deve ser executada em um ambiente de backend, como uma Supabase Edge Function, n√£o diretamente do navegador por quest√µes de seguran√ßa.`;
                    listarLoginsMessage.style.display = 'block';
                    usersTableBody.innerHTML = '';
                    console.error("Erro ao listar usu√°rios (requer Service Role Key):", error);
                    return;
                }
                usersTableBody.innerHTML = '';
                users.forEach(user => {
                    const row = usersTableBody.insertRow();
                    row.innerHTML = `<td>${user.email}</td>`;
                });
            }

            async function handleChangePassword() {
                const newPassword = newPasswordInput.value;
                if (newPassword !== confirmNewPasswordInput.value) {
                    changePasswordErrorMessage.textContent = "As novas senhas n√£o coincidem.";
                    changePasswordErrorMessage.style.display = 'block';
                    return;
                }
                if (newPassword.length < 6) {
                    changePasswordErrorMessage.textContent = "A nova senha deve ter pelo menos 6 caracteres.";
                    changePasswordErrorMessage.style.display = 'block';
                    return;
                }
                changePasswordErrorMessage.style.display = 'none';

                const { error } = await _supabase.auth.updateUser({ password: newPassword });
                if (error) {
                    changePasswordErrorMessage.textContent = `Erro: ${error.message}`;
                    changePasswordErrorMessage.style.display = 'block';
                } else {
                    alert("Senha alterada com sucesso!");
                    showScreen('dashboard');
                }
            }

            // --- FUN√á√ïES DE GERENCIAMENTO DE DI√ÅRIAS (EDITAR/DELETAR) ---
            async function showGerenciarDiariasScreen() {
                gerenciarDiariasTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Carregando di√°rias...</td></tr>';
                showScreen('gerenciarDiarias');
                const { data, error } = await _supabase.from('diarias_lancadas')
                    .select(`*, colaboradores(nome_completo)`)
                    .order('data_diaria', { ascending: false })
                    .limit(50); // Limita a 50 mais recentes para performance

                if (error) {
                    console.error("Erro ao buscar di√°rias para gerenciamento:", error);
                    gerenciarDiariasTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Erro ao carregar.</td></tr>';
                    return;
                }
                renderGerenciarDiariasTable(data);
            }

            function renderGerenciarDiariasTable(diarias) {
                gerenciarDiariasTableBody.innerHTML = '';
                if (diarias.length === 0) {
                    gerenciarDiariasTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Nenhuma di√°ria lan√ßada.</td></tr>';
                    return;
                }
                diarias.forEach(d => {
                    const row = gerenciarDiariasTableBody.insertRow();
                    row.innerHTML = `
                        <td>${d.colaboradores ? d.colaboradores.nome_completo : 'Desconhecido'}</td>
                        <td>${new Date(d.data_diaria + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                        <td>${d.funcao_colaborador}</td> 
                        <td>${d.setor_colaborador}</td> 
                        <td>${(d.valor_pago || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td> 
                        <td>${d.lancado_por || 'N/A'}</td>
                        <td>
                            <button class="btn-secondary edit-diaria-btn" data-id="${d.id}">Editar</button>
                            <button class="btn-danger delete-diaria-btn" data-id="${d.id}" style="background-color: var(--color-danger); margin-left: 5px;">Excluir</button>
                        </td>
                    `;
                });
                document.querySelectorAll('.edit-diaria-btn').forEach(btn => btn.addEventListener('click', handleEditDiaria));
                document.querySelectorAll('.delete-diaria-btn').forEach(btn => btn.addEventListener('click', handleDeleteDiaria));
            }

            async function handleEditDiaria(event) {
                const diariaId = event.target.dataset.id;
                const { data, error } = await _supabase.from('diarias_lancadas').select(`*, colaboradores(nome_completo)`)
                    .eq('id', diariaId).single();
                if (error) {
                    alert("Erro ao carregar dados da di√°ria.");
                    console.error(error);
                    return;
                }

                // Popula o select de fun√ß√£o no modal de edi√ß√£o
                const funcoes = [...new Set(regras_pagamento.map(r => r.funcao))].sort();
                editDiariaFuncaoSelect.innerHTML = '<option value="">-- Selecione a Fun√ß√£o --</option>';
                funcoes.forEach(funcao => {
                    editDiariaFuncaoSelect.innerHTML += `<option value="${funcao}">${funcao}</option>`;
                });
                
                editDiariaIdInput.value = data.id;
                editDiariaColaboradorNomeInput.value = data.colaboradores.nome_completo;
                editDiariaDataInput.value = data.data_diaria;
                editDiariaFuncaoSelect.value = data.funcao_colaborador; 
                editDiariaSetorSelect.value = data.setor_colaborador; 
                editDiariaValorInput.value = (data.valor_pago || 0).toFixed(2); 
                editDiariaDobrouCheckbox.checked = data.dobrou;
                editDiariaHoraEntradaInput.value = data.horario_entrada || '';
                editDiariaHoraSaidaInput.value = data.horario_saida || '';

                // Mostra/esconde campos din√¢micos com base na regra ap√≥s preencher a fun√ß√£o
                await toggleDiariaFields(true);
                
                editDiariaModal.classList.add('active');
            }

            async function handleSaveEditDiaria() {
                const diariaId = editDiariaIdInput.value;
                
                // Recalcula o valor da di√°ria com base nas edi√ß√µes
                const { valorCalculado, horasTrabalhadas } = calculateDiariaValue(true);
                
                const updatedData = {
                    data_diaria: editDiariaDataInput.value,
                    funcao_colaborador: editDiariaFuncaoSelect.value, 
                    setor_colaborador: editDiariaSetorSelect.value, 
                    valor_pago: valorCalculado, 
                    dobrou: editDiariaDobrouCheckbox.checked,
                    horario_entrada: editDiariaHoraEntradaInput.value || null,
                    horario_saida: editDiariaHoraSaidaInput.value || null,
                    horas_trabalhadas: horasTrabalhadas 
                };

                const { data: oldDiaria, error: fetchError } = await _supabase.from('diarias_lancadas').select('valor_pago, colaboradores(nome_completo), funcao_colaborador').eq('id', diariaId).single(); 
                if (fetchError) {
                    alert("Erro ao buscar dados antigos da di√°ria para log. A atualiza√ß√£o ser√° impedida para evitar logs incorretos.");
                    console.error("Erro ao buscar oldDiaria para log:", fetchError);
                    return;
                }

                const { data: updateData, error: updateError } = await _supabase.from('diarias_lancadas').update(updatedData).eq('id', diariaId).select().single();
                if (updateError) {
                    alert("Erro ao salvar altera√ß√µes: " + updateError.message); 
                    console.error("Erro ao salvar altera√ß√µes:", updateError);
                } else {
                    const { data: { user } } = await _supabase.auth.getUser();
                    await logAction('UPDATED', diariaId, user.email, `Di√°ria de ${oldDiaria.colaboradores.nome_completo} (Fun√ß√£o: ${oldDiaria.funcao_colaborador}, Valor anterior: R$ ${oldDiaria.valor_pago.toFixed(2)}) atualizada para R$ ${updateData.valor_pago.toFixed(2)}.`); 
                    alert("Di√°ria atualizada com sucesso!");
                    editDiariaModal.classList.remove('active');
                    showGerenciarDiariasScreen();
                }
            }

            async function handleDeleteDiaria(event) {
                const diariaId = event.target.dataset.id;
                if (!confirm("Tem certeza que deseja excluir esta di√°ria? Esta a√ß√£o n√£o pode ser desfeita.")) {
                    return;
                }

                // Fetch oldDiaria BEFORE deleting it, so we can log its details.
                const { data: oldDiaria, error: fetchError } = await _supabase.from('diarias_lancadas').select('valor_pago, colaboradores(nome_completo), funcao_colaborador').eq('id', diariaId).single();
                if (fetchError) {
                    alert("Erro ao buscar dados da di√°ria para log. A exclus√£o ser√° impedida para evitar logs incorretos.");
                    console.error("Erro ao buscar oldDiaria para log:", fetchError);
                    return;
                }

                const { error: deleteError } = await _supabase.from('diarias_lancadas').delete().eq('id', diariaId);
                if (deleteError) {
                    alert("Erro ao excluir di√°ria: " + deleteError.message); 
                    console.error("Erro ao excluir di√°ria:", deleteError);
                } else {
                    const { data: { user } } = await _supabase.auth.getUser();
                    // Log com diaria_id = null porque a di√°ria original n√£o existe mais
                    await logAction('DELETED', null, user.email, `Di√°ria de ${oldDiaria.colaboradores.nome_completo} (Fun√ß√£o: ${oldDiaria.funcao_colaborador}, Valor: R$ ${oldDiaria.valor_pago.toFixed(2)}) foi exclu√≠da.`);
                    alert("Di√°ria exclu√≠da com sucesso!");
                    showGerenciarDiariasScreen();
                }
            }

            // --- FUN√á√ïES DE LOG (HIST√ìRICO) ---
            async function logAction(action, diaria_id, user_email, details) {
                const { error } = await _supabase.from('diaria_historico').insert([{ 
                    action: action,
                    diaria_id: diaria_id, 
                    user_email: user_email,
                    details: details
                }]);
                if (error) {
                    console.error("Erro ao registrar a√ß√£o no hist√≥rico:", error);
                }
            }

            async function showHistoricoScreen() {
                historicoTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Carregando hist√≥rico...</td></tr>';
                showScreen('historico');
                const { data, error } = await _supabase.from('diaria_historico')
                    .select('*') 
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (error) {
                    console.error("Erro ao buscar hist√≥rico:", error);
                    historicoTableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 20px;">Erro ao carregar hist√≥rico: ${error.message || 'Erro desconhecido. Verifique as pol√≠ticas de RLS ou a exist√™ncia da coluna created_at.'}</td></tr>`;
                    return;
                }
                renderHistoricoTable(data);
            }

            function renderHistoricoTable(historico) {
                historicoTableBody.innerHTML = '';
                if (historico.length === 0) {
                    historicoTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Nenhum registro no hist√≥rico.</td></tr>';
                    return;
                }
                historico.forEach(h => {
                    const row = historicoTableBody.insertRow();
                    row.innerHTML = `
                        <td>${new Date(h.created_at).toLocaleString('pt-BR')}</td>
                        <td>${h.user_email}</td>
                        <td>${h.details}</td> `;
                });
            }

            // --- FUN√á√ïES DE REGRAS DE PAGAMENTO ---
            async function fetchRegrasPagamento() {
                const { data, error } = await _supabase.from('regras_pagamento').select('*');
                if (error) {
                    console.error("Erro ao buscar regras de pagamento:", error);
                    alert("Erro cr√≠tico: N√£o foi poss√≠vel carregar as regras de pagamento.");
                    regras_pagamento = [];
                } else {
                    regras_pagamento = data;
                    populateFuncaoSelects();
                }
            }
            
            function populateFuncaoSelects() {
                const funcoes = [...new Set(regras_pagamento.map(r => r.funcao))].sort();
                const selects = [colabFuncaoSelect, editDiariaFuncaoSelect]; 
                
                selects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">-- Selecione a Fun√ß√£o --</option>';
                    funcoes.forEach(funcao => {
                        select.innerHTML += `<option value="${funcao}">${funcao}</option>`;
                    });
                    if (Array.from(select.options).some(option => option.value === currentValue)) {
                        select.value = currentValue;
                    }
                });
            }

            async function showGerenciarRegrasScreen() {
                regrasPagamentoList.innerHTML = '<p style="text-align: center;">Carregando regras...</p>';
                showScreen('gerenciarRegras');
                await fetchRegrasPagamento(); 
                renderRegrasPagamento();
            }

            function renderRegrasPagamento() {
                regrasPagamentoList.innerHTML = '';
                if (regras_pagamento.length === 0) {
                    regrasPagamentoList.innerHTML = '<p style="text-align: center;">Nenhuma regra de pagamento cadastrada. Clique em "+ Adicionar Nova Regra" para come√ßar.</p>';
                    return;
                }
                regras_pagamento.sort((a, b) => a.funcao.localeCompare(b.funcao)).forEach(regra => {
                    const regraDiv = document.createElement('div');
                    regraDiv.className = 'regra-item';
                    regraDiv.dataset.id = regra.id;
                    regraDiv.innerHTML = `
                        <strong>Fun√ß√£o: ${regra.funcao}</strong>
                        <div class="regra-fields">
                            <div class="form-group">
                                <label for="tipoCalculo-${regra.id}">Tipo de C√°lculo</label>
                                <select id="tipoCalculo-${regra.id}" data-id="${regra.id}" data-field="tipo_calculo">
                                    <option value="Fixo" ${regra.tipo_calculo === 'Fixo' ? 'selected' : ''}>Fixo</option>
                                    <option value="Fixo com Dobra" ${regra.tipo_calculo === 'Fixo com Dobra' ? 'selected' : ''}>Fixo com Dobra/Hora Extra</option>
                                </select>
                            </div>
                            <div class="form-group" id="valorBaseGroup-${regra.id}">
                                <label for="valorBase-${regra.id}">Valor Base (R$)</label>
                                <input type="number" step="0.01" id="valorBase-${regra.id}" data-id="${regra.id}" data-field="valor_base" value="${regra.valor_base || ''}">
                            </div>
                            <div class="form-group" id="horasBaseGroup-${regra.id}">
                                <label for="horasBase-${regra.id}">Horas Base</label>
                                <input type="number" step="0.1" id="horasBase-${regra.id}" data-id="${regra.id}" data-field="horas_base" value="${regra.horas_base || ''}">
                            </div>
                            <div class="form-group" id="valorHoraExtraGroup-${regra.id}">
                                <label for="valorHoraExtra-${regra.id}">Valor Hora Extra (R$)</label>
                                <input type="number" step="0.01" id="valorHoraExtra-${regra.id}" data-id="${regra.id}" data-field="valor_hora_extra" value="${regra.valor_hora_extra || ''}">
                            </div>
                            <div class="form-group" id="valorDobraSemanaGroup-${regra.id}">
                                <label for="valorDobraSemana-${regra.id}">Valor Dobra (Semana)</label>
                                <input type="number" step="0.01" id="valorDobraSemana-${regra.id}" data-id="${regra.id}" data-field="valor_dobra_semana" value="${regra.valor_dobra_semana || ''}">
                            </div>
                            <div class="form-group" id="valorDobraFDSGroup-${regra.id}">
                                <label for="valorDobraFDS-${regra.id}">Valor Dobra (FDS)</label>
                                <input type="number" step="0.01" id="valorDobraFDS-${regra.id}" data-id="${regra.id}" data-field="valor_dobra_fds" value="${regra.valor_dobra_fds || ''}">
                            </div>
                        </div>
                        <div class="regra-buttons">
                            <button class="btn-primary save-regra-btn" data-id="${regra.id}">Salvar</button>
                            <button class="btn-danger delete-regra-btn" data-id="${regra.id}" style="background-color: var(--color-danger); margin-left: 5px;">Excluir</button>
                        </div>
                    `;
                    regrasPagamentoList.appendChild(regraDiv);
                    toggleRegraFieldsVisibility(regra.id, regra.tipo_calculo);
                });

                regrasPagamentoList.querySelectorAll('.save-regra-btn').forEach(button => {
                    button.addEventListener('click', handleSaveRegra);
                });
                regrasPagamentoList.querySelectorAll('.delete-regra-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteRegra);
                });

                regrasPagamentoList.querySelectorAll('[data-field="tipo_calculo"]').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const id = e.target.dataset.id;
                        const newType = e.target.value;
                        toggleRegraFieldsVisibility(id, newType);
                    });
                });
            }

            function toggleRegraFieldsVisibility(id, type) {
                const isFixed = type === 'Fixo';
                const isHourlyOrDoubled = type === 'Fixo com Dobra';

                const groupsToToggle = [
                    `valorBaseGroup-${id}`, `horasBaseGroup-${id}`, `valorHoraExtraGroup-${id}`,
                    `valorDobraSemanaGroup-${id}`, `valorDobraFDSGroup-${id}`
                ];
                groupsToToggle.forEach(groupId => {
                    const el = document.getElementById(groupId);
                    if (el) el.classList.add('hidden');
                });

                if (isFixed || isHourlyOrDoubled) { 
                    const el = document.getElementById(`valorBaseGroup-${id}`);
                    if (el) el.classList.remove('hidden');
                }
                if (isHourlyOrDoubled) {
                    const horasBaseEl = document.getElementById(`horasBaseGroup-${id}`);
                    const valorHoraExtraEl = document.getElementById(`valorHoraExtraGroup-${id}`);
                    const valorDobraSemanaEl = document.getElementById(`valorDobraSemanaGroup-${id}`);
                    const valorDobraFDSEl = document.getElementById(`valorDobraFDSGroup-${id}`);
                    
                    if(horasBaseEl) horasBaseEl.classList.remove('hidden');
                    if(valorHoraExtraEl) valorHoraExtraEl.classList.remove('hidden');
                    if(valorDobraSemanaEl) valorDobraSemanaEl.classList.remove('hidden');
                    if(valorDobraFDSEl) valorDobraFDSEl.classList.remove('hidden');
                }

                const currentRegraDiv = document.querySelector(`.regra-item[data-id="${id}"]`);
                if (!currentRegraDiv) return;

                if (!isHourlyOrDoubled) { 
                    const horasBaseInput = currentRegraDiv.querySelector(`#horasBase-${id}`);
                    const valorHoraExtraInput = currentRegraDiv.querySelector(`#valorHoraExtra-${id}`);
                    const valorDobraSemanaInput = currentRegraDiv.querySelector(`#valorDobraSemana-${id}`);
                    const valorDobraFDSInput = currentRegraDiv.querySelector(`#valorDobraFDS-${id}`);
                    
                    if(horasBaseInput) horasBaseInput.value = '';
                    if(valorHoraExtraInput) valorHoraExtraInput.value = '';
                    if(valorDobraSemanaInput) valorDobraSemanaInput.value = '';
                    if(valorDobraFDSInput) valorDobraFDSInput.value = '';
                }
                if (!isFixed && !isHourlyOrDoubled) { 
                    const valorBaseInput = currentRegraDiv.querySelector(`#valorBase-${id}`);
                    if(valorBaseInput) valorBaseInput.value = '';
                }
            }

            async function handleAdicionarNovaRegra() {
                const novaFuncao = prompt("Digite o nome da nova fun√ß√£o para a regra de pagamento:");
                if (!novaFuncao || novaFuncao.trim() === "") {
                    alert("O nome da fun√ß√£o n√£o pode ser vazio.");
                    return;
                }
                if (regras_pagamento.some(r => r.funcao.toLowerCase() === novaFuncao.trim().toLowerCase())) {
                    alert("J√° existe uma regra para esta fun√ß√£o.");
                    return;
                }

                const { data, error } = await _supabase.from('regras_pagamento').insert([{
                    funcao: novaFuncao.trim(),
                    tipo_calculo: 'Fixo', // Padr√£o
                    valor_base: 0
                }]).select().single();

                if (error) {
                    alert(`Erro ao adicionar nova regra: ${error.message}`);
                    console.error("Erro ao adicionar regra:", error);
                } else {
                    alert(`Regra para "${novaFuncao}" adicionada com sucesso!`);
                    showGerenciarRegrasScreen(); 
                }
            }

            async function handleSaveRegra(event) {
                const regraId = event.target.dataset.id;
                const regraDiv = document.querySelector(`.regra-item[data-id="${regraId}"]`);
                
                const updatedFields = {};
                regraDiv.querySelectorAll('input[data-field], select[data-field]').forEach(input => {
                    const field = input.dataset.field;
                    let value = input.value;

                    if (input.type === 'number') {
                        value = value === '' ? null : parseFloat(value); 
                    }
                    updatedFields[field] = value;
                });
                
                const { error } = await _supabase
                    .from('regras_pagamento')
                    .update(updatedFields)
                    .eq('id', regraId);

                if (error) {
                    alert(`Erro ao atualizar regra: ${error.message}`);
                    console.error("Erro na atualiza√ß√£o da regra:", error);
                } else {
                    alert('Regra de pagamento atualizada com sucesso!');
                    showGerenciarRegrasScreen(); 
                }
            }

            async function handleDeleteRegra(event) {
                const regraId = event.target.dataset.id;
                if (!confirm("Tem certeza que deseja excluir esta regra de pagamento?")) {
                    return;
                }
                const { error } = await _supabase.from('regras_pagamento').delete().eq('id', regraId);
                if (error) {
                    alert(`Erro ao excluir regra: ${error.message}`);
                    console.error("Erro ao excluir regra:", error);
                } else {
                    alert('Regra de pagamento exclu√≠da com sucesso!');
                    showGerenciarRegrasScreen(); 
                }
            }

            // --- FUN√á√ïES DE MASCARAMENTO ---
            function formatCpf(value) {
                if (!value) return '';
                value = String(value).replace(/\D/g, ''); 
                if (value.length > 11) value = value.substring(0, 11);
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                return value;
            }

            function formatTelefone(value) {
                if (!value) return '';
                value = String(value).replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);
                if (value.length > 10) {
                    value = value.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3');
                } else if (value.length > 5) {
                    value = value.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, '($1) $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/^(\d\d)(\d{0,5})/, '($1) $2');
                }
                return value;
            }

            // Aplicar m√°scaras nos inputs de colaborador
            colabCpfInput.addEventListener('input', (e) => {
                e.target.value = formatCpf(e.target.value);
            });
            colabTelefoneInput.addEventListener('input', (e) => {
                e.target.value = formatTelefone(e.target.value);
            });

            // --- NOVO: Relat√≥rio de Colaboradores ---
            async function showRelatorioColaboradoresScreen() {
                relatorioColaboradoresTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Carregando colaboradores...</td></tr>';
                showScreen('relatorioColaboradores');
                
                const { data, error } = await _supabase.from('colaboradores').select('*').order('nome_completo');
                if (error) {
                    console.error("Erro ao buscar colaboradores para relat√≥rio:", error);
                    alert("Erro ao carregar colaboradores para relat√≥rio.");
                    relatorioColaboradoresTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Erro ao carregar colaboradores.</td></tr>';
                    return;
                }

                if (data.length === 0) {
                    relatorioColaboradoresTableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Nenhum colaborador cadastrado.</td></tr>';
                    return;
                }

                relatorioColaboradoresTableBody.innerHTML = '';
                data.forEach(colab => {
                    const row = relatorioColaboradoresTableBody.insertRow();
                    row.innerHTML = `
                        <td>${colab.nome_completo}</td>
                        <td>${colab.funcao}</td>
                        <td>${colab.setor}</td>
                        <td>${colab.chave_pix || 'N/A'}</td>
                        <td>${formatCpf(colab.cpf) || 'N/A'}</td>
                        <td>${formatTelefone(colab.telefone) || 'N/A'}</td>
                        <td>${colab.endereco || 'N/A'}</td>
                        <td>${colab.data_nascimento ? new Date(colab.data_nascimento + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'N/A'}</td>
                        <td>${colab.nome_mae || 'N/A'}</td>
                    `;
                });
            }

            async function gerarRelatorioColaboradoresPdf() {
                const { data: colaboradoresData, error } = await _supabase.from('colaboradores').select('*').order('nome_completo');
                if (error) {
                    console.error("Erro ao buscar colaboradores para PDF:", error);
                    alert("Erro ao gerar PDF de colaboradores.");
                    return;
                }

                if (colaboradoresData.length === 0) {
                    alert('Nenhum colaborador para gerar relat√≥rio.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape'); // 'landscape' para mais colunas
                const defaultMargin = 15;
                const usableWidth = doc.internal.pageSize.getWidth() - (defaultMargin * 2);

                doc.setFont("helvetica", "bold");
                doc.setFontSize(20);
                doc.setTextColor(52, 58, 64);
                doc.text("Relat√≥rio de Colaboradores Cadastrados", doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(108, 117, 125);
                const now = new Date();
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: 'America/Fortaleza' };
                const generatedDateTime = now.toLocaleString('pt-BR', options);
                doc.text(`Gerado em: ${generatedDateTime}`, doc.internal.pageSize.getWidth() / 2, 28, { align: "center" });

                doc.autoTable({
                    startY: 35,
                    head: [['Nome Completo', 'Fun√ß√£o', 'Setor', 'PIX', 'CPF', 'Telefone', 'Endere√ßo', 'Nasc.', 'Nome M√£e']],
                    body: colaboradoresData.map(colab => [
                        colab.nome_completo,
                        colab.funcao,
                        colab.setor,
                        colab.chave_pix || '',
                        formatCpf(colab.cpf) || '',
                        formatTelefone(colab.telefone) || '',
                        colab.endereco || '',
                        colab.data_nascimento ? new Date(colab.data_nascimento + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : '',
                        colab.nome_mae || ''
                    ]),
                    theme: 'striped',
                    styles: {
                        fontSize: 8, // Fonte menor para caber mais
                        cellPadding: 2,
                        overflow: 'linebreak',
                        font: "helvetica",
                        textColor: [52, 58, 64],
                    },
                    headStyles: {
                        fillColor: [63, 106, 216],
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 9,
                    },
                    alternateRowStyles: { fillColor: [248, 249, 250] },
                    margin: { horizontal: defaultMargin },
                    // Ajuste de largura de colunas para PDF
                    columnStyles: {
                        0: { cellWidth: usableWidth * 0.18 }, // Nome
                        1: { cellWidth: usableWidth * 0.10 }, // Fun√ß√£o
                        2: { cellWidth: usableWidth * 0.10 }, // Setor
                        3: { cellWidth: usableWidth * 0.12 }, // PIX
                        4: { cellWidth: usableWidth * 0.12 }, // CPF
                        5: { cellWidth: usableWidth * 0.12 }, // Telefone
                        6: { cellWidth: usableWidth * 0.16 }, // Endere√ßo
                        7: { cellWidth: 'auto' }, // Nasc.
                        8: { cellWidth: 'auto' }  // Nome M√£e
                    },
                    didDrawPage: function (data) {
                        let str = "P√°gina " + doc.internal.getNumberOfPages();
                        doc.setFontSize(10);
                        doc.setTextColor(108, 117, 125);
                        doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                    }
                });

                doc.save(`Relatorio_Colaboradores_${new Date().toLocaleDateString('pt-BR')}.pdf`);
                alert('Relat√≥rio de Colaboradores PDF gerado com sucesso!');
            }


            // --- INICIALIZA√á√ÉO E LISTENERS GERAIS ---
            async function initializeApp() {
                // Login
                loginButton.addEventListener('click', handleLogin);
                logoutButton.addEventListener('click', handleLogout);
                loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
                
                // Colaboradores
                if(btnGoToListarColaboradores) btnGoToListarColaboradores.addEventListener('click', async () => {
                    await fetchAndRenderColaboradores();
                    showScreen('listarColaboradores');
                });
                if(btnGoToAdicionarColaborador) btnGoToAdicionarColaborador.addEventListener('click', () => {
                    colabNomeInput.value = ''; 
                    colabFuncaoSelect.value = ''; 
                    colabSetorSelect.value = ''; 
                    colabPixInput.value = ''; 
                    colabCpfInput.value = ''; 
                    colabTelefoneInput.value = ''; 
                    colabEnderecoInput.value = '';
                    colabDataNascimentoInput.value = '';
                    colabNomeMaeInput.value = '';
                    editingColaboradorId = null; 
                    colaboradorFormTitle.textContent = 'Adicionar Novo Colaborador';
                    btnSalvarColaborador.textContent = 'Salvar Novo Colaborador';
                    btnSalvarColaborador.classList.remove('btn-primary'); 
                    btnSalvarColaborador.classList.add('btn-success');
                    showScreen('adicionarColaborador');
                });
                if(btnAdicionarColabVoltar) btnAdicionarColabVoltar.addEventListener('click', () => showScreen('listarColaboradores')); 
                if(btnListarColabVoltar) btnListarColabVoltar.addEventListener('click', () => showScreen('dashboard')); 
                if(btnSalvarColaborador) btnSalvarColaborador.addEventListener('click', handleSalvarColaborador);
                
                // Lan√ßamento de Di√°rias
                if(btnGoToLancarDiaria) btnGoToLancarDiaria.addEventListener('click', showLancarDiariasScreen);
                if(btnLancarDiariasVoltar) btnLancarDiariasVoltar.addEventListener('click', () => showScreen('dashboard')); 
                diariaColaboradorSelect.addEventListener('change', () => toggleDiariaFields(false));
                diariaDobrouCheckbox.addEventListener('change', () => toggleDiariaFields(false));
                diariaHoraEntradaInput.addEventListener('change', () => toggleDiariaFields(false)); 
                diariaHoraSaidaInput.addEventListener('change', () => toggleDiariaFields(false)); 
                if(btnSalvarDiaria) btnSalvarDiaria.addEventListener('click', handleSalvarDiaria);
                
                // Relat√≥rios
                if(btnGoToRelatorios) btnGoToRelatorios.addEventListener('click', showRelatoriosScreen);
                if(btnRelatoriosVoltar) btnRelatoriosVoltar.addEventListener('click', () => {
                    resumoPagamentosDiv.style.display = 'none';
                    resumoGastosDiv.style.display = 'none';
                    showScreen('dashboard');
                });
                if(btnVerResumo) btnVerResumo.addEventListener('click', async () => {
                    const dataInicio = relatorioDataInicioInput.value;
                    const dataFim = relatorioDataFimInput.value;
                    if (!dataInicio || !dataFim) {
                        alert('Por favor, selecione as datas de in√≠cio e fim para o relat√≥rio.');
                        return;
                    }
                    const dados = await processarDadosRelatorio(dataInicio, dataFim);
                    if (dados) {
                        exibirResumoNaTela(dados);
                    } else {
                        resumoPagamentosDiv.style.display = 'none';
                        resumoGastosDiv.style.display = 'none';
                    }
                });
                if(btnGerarRelatorioXlsx) btnGerarRelatorioXlsx.addEventListener('click', gerarRelatorioXlsx);

                // Cria√ß√£o de Login
                if(btnGoToCriarLogin) btnGoToCriarLogin.addEventListener('click', () => {
                    createUserEmailInput.value = '';
                    generatedPasswordDisplay.value = ''; 
                    createUserErrorMessage.style.display = 'none';
                    showScreen('criarLogin');
                });
                if(btnCriarLoginVoltar) btnCriarLoginVoltar.addEventListener('click', () => showScreen('dashboard'));
                if(btnCreateUser) btnCreateUser.addEventListener('click', handleCreateUser);
                createUserEmailInput.addEventListener('keypress', (e) => { 
                    if (e.key === 'Enter') handleCreateUser(); 
                });
                
                // Listar Logins
                if(btnGoToListarLogins) btnGoToListarLogins.addEventListener('click', showListarLoginsScreen);
                if(btnListarLoginsVoltar) btnListarLoginsVoltar.addEventListener('click', () => showScreen('dashboard'));

                // Alterar Senha
                if(btnGoToAlterarSenha) btnGoToAlterarSenha.addEventListener('click', () => {
                    currentPasswordInput.value = '';
                    newPasswordInput.value = '';
                    confirmNewPasswordInput.value = '';
                    changePasswordErrorMessage.style.display = 'none';
                    showScreen('alterarSenha');
                });
                if(btnAlterarSenhaVoltar) btnAlterarSenhaVoltar.addEventListener('click', () => showScreen('dashboard'));
                if(btnChangePassword) btnChangePassword.addEventListener('click', handleChangePassword);
                confirmNewPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleChangePassword();
                });

                // Gerenciar Di√°rias
                if(btnGoToGerenciarDiarias) btnGoToGerenciarDiarias.addEventListener('click', showGerenciarDiariasScreen);
                if(btnGerenciarDiariasVoltar) btnGerenciarDiariasVoltar.addEventListener('click', () => showScreen('dashboard'));
                if(closeEditModalButton) closeEditModalButton.addEventListener('click', () => editDiariaModal.classList.remove('active'));
                if(cancelEditDiariaButton) cancelEditDiariaButton.addEventListener('click', () => editDiariaModal.classList.remove('active'));
                if(saveEditDiariaButton) saveEditDiariaButton.addEventListener('click', handleSaveEditDiaria);
                window.addEventListener('click', (event) => {
                    if (event.target == editDiariaModal) {
                        editDiariaModal.classList.remove('active');
                    }
                });
                editDiariaFuncaoSelect.addEventListener('change', () => toggleDiariaFields(true));
                editDiariaDobrouCheckbox.addEventListener('change', () => toggleDiariaFields(true));
                editDiariaHoraEntradaInput.addEventListener('change', () => toggleDiariaFields(true));
                editDiariaHoraSaidaInput.addEventListener('change', () => toggleDiariaFields(true));

                // Hist√≥rico
                if(btnGoToHistorico) btnGoToHistorico.addEventListener('click', showHistoricoScreen);
                if(btnHistoricoVoltar) btnHistoricoVoltar.addEventListener('click', () => showScreen('dashboard'));

                // Gerenciar Regras de Pagamento (NOVO)
                if(btnGoToGerenciarRegras) btnGoToGerenciarRegras.addEventListener('click', showGerenciarRegrasScreen);
                if(btnGerenciarRegrasVoltar) btnGerenciarRegrasVoltar.addEventListener('click', () => showScreen('dashboard'));
                if(btnAdicionarNovaRegra) btnAdicionarNovaRegra.addEventListener('click', handleAdicionarNovaRegra);

                // NOVO: Relat√≥rio de Colaboradores
                if(btnGoToRelatorioColaboradores) btnGoToRelatorioColaboradores.addEventListener('click', showRelatorioColaboradoresScreen);
                if(btnRelatorioColaboradoresVoltar) btnRelatorioColaboradoresVoltar.addEventListener('click', () => showScreen('dashboard'));
                if(btnGerarRelatorioColaboradoresPdf) btnGerarRelatorioColaboradoresPdf.addEventListener('click', gerarRelatorioColaboradoresPdf);
                
                // Inicializa√ß√£o da sess√£o
                const { data: { session } } = await _supabase.auth.getSession();
                if (session) { await setupDashboard(session.user); } 
                else { showScreen('login'); }
            }
            initializeApp();
        });
    </script>
</body>
</html>